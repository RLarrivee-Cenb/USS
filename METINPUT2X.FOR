CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C		METINPUT.FOR
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
	INTEGER UFO_OPEN
C
	EXTERNAL UFO_OPEN
C
	INCLUDE 'FMS$EXAMPLES:FDVDEF'
CCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
	INTEGER  WORKSPACE( 3 ),	!General workspace
	1	 CHECKWKSP( 3 ),	!Check workspace
	2	 TCA( 3 )		!Terminal Control Area
c
c
	structure /bozo2/
c
		character*4	key		! yymm	(primary key)
		real		msil(3,31)	! mine ind. sio2 by shift,day
		real		cr12(3,31)	! crusher +1/2 by shift,day
		real 		flfr(3,31)	! flf davis tube recovery
		real		flfs(3,31)	! flf davis tube sio2
		real		fls(3,31)	! flf sio2
		real		flts(3,31)	! flot tails sio2
		real		aeff(4,3,31)	! amine efficiency by cell
c
c
	end structure
c
	record /bozo2/ hsd
c
c
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
 	DOUBLE PRECISION CT(18),FT(18),SCREEN(14,3,2,5),COMP(2,3,2,5),
	1  CAB(2,3,5),SIL(3,5),FILT2(5,3),BL2,FILT3(5,3),BL3,TOTAL,
	1  H2O,RMF,FTMF,BOIC(150),HOIC(150),CX(5),MX(5),AX(5),SX(5),
	1  FLUXG,P34,P12,FCA(2,3),FMG(2,3),FAL(2,3),FSI(2,3),SM,PP(2),
	1  DTR,DTS,PPx(3),
	1  H2O3,RMF3,DTR3,DTS3,P343,TS,TS3,PPX3(3)
C                                                                 
	INTEGER AMB(3),BMH(3),BD(2),YSTRDAY(2),NEW(3),LAST(3),
	1	IN,INO,DAT(2),INTV(2),IS,IS2,IS3,IH,INPDATE(2)
C
	DIMENSION ARD(8)
C
	CHARACTER PL(2)*2/'CN','AG'/,FN2*25,HSKEY*4,
	1	MO(12)*3/'JAN','FEB','MAR','APR',
	2	'MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'/
	3	,CAD*9,FILN*16,SH*2,PS*3,TEMP*12,MINP,AINTV/'1'/,
	1	INAM(4)*6/'AMIOIC','BMIOIC',' AMBOP',' BMHOP'/,  
	1	PART(3)*16/'SCREEN FRACTIONS','       SIO2     ',
	2	'FILTER CAKE     '/,AYSTR*23,FILNAM*30,ASC,ASC2*3,
	1	PP1*29/'SCREEN FRACTIONS,COMPRESSIONS'/             
C
	CHARACTER SHED*32/'+5/8,+1/2,+3/8,+1/4,4M,+28M,-28M'/,
C
	2	CHED*38/'COMPRESSION AVG., -200 PCT.'/,
C
	2	BHED*18 /'AL203,CAO,MGO'/,
	2	BHEX*18 /'SIO2,AL203,CAO,MGO'/,
C
	3	FES*4/'SIO2'/,
C
	4	FILT*26/'SIO2,-270,-500,AL2O3,CAO,MGO'/,
C
	5	BAT(2)*6/'BEFORE','AFTER '/
C
	CHARACTER AA*20
C
C
	CALL SYS$BINTIM (AINTV,INTV) !convert 24 hr interval to binary
C
C
	CALL FDV$ATERM( %DESCR(TCA),12 ,2)
	CALL FDV$AWKSP( %DESCR(WORKSPACE), 2000 )
	CALL FDV$LOPEN( 'USER_D:[METREP]METINPUT', 1 )
ccccc	call fdv$spada (0)
	CALL FDV$SPON ()
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
	CALL FDV$CDISP ('METINPUT2')
C
C	step 1 and 2 concentrator input
C
1	CONTINUE
C
	IBACK=0
C
C
	NNN=0
C
	OPEN (13,FILE='MET_P:AMIBMI.DAY',STATUS='UNKNOWN',FORM='UNFORMATTED',
	1	ACCESS='DIRECT',RECL=2)
C
	READ (13,REC=1)DAT
C
	CALL SYS$ASCTIM (,AYSTR,DAT,)     	!cnvt time to ascii
C
		IF (AYSTR(1:1) .EQ. ' ') AYSTR(1:1)='0'
C
C
	CALL FDV$PUT (AYSTR(1:2)//AYSTR(4:6)//AYSTR(8:11),'DATE')
C
15	CALL FDV$GET (AA,I,'OK')
C
	IF (AA(1:1) .EQ. 'N' .OR. AA(1:1) .EQ. 'n') THEN
		NNN=1
		CALL FDV$PUT (' ','OK')
		CALL FDV$GET (AA,I,'DATE')
		IF (AA(2:2) .EQ. ' ') AA(1:2)='0'//AA(1:1)
		IF (AA(1:1) .EQ. ' ') AA(1:1)='0'
		AYSTR=AA(1:2)//'-'//AA(3:5)//'-'//AA(6:9)
		CALL SYS$BINTIM (AYSTR,INPDATE)
		GO TO 15
	END IF
C
	IF (.NOT. (AA(1:1) .EQ. 'Y' .OR. AA(1:1) .EQ. 'y')) go to 99
C
C
CCCC	IF (IBACK .NE. 0) GO TO 2
C
	OPEN (UNIT=42,FILE='MET_P:AMIOIC'//AYSTR(1:2)//'.DAT',
	1	FORM='UNFORMATTED',STATUS='UNKNOWN',ERR=2)
C
C
	OPEN (UNIT=43,FILE='MET_P:BMIOIC'//AYSTR(1:2)//'.DAT',
	1	FORM='UNFORMATTED',STATUS='UNKNOWN',ERR=2)
C
C
	READ (42,ERR=892)BOIC
C
892	READ (43,ERR=298)HOIC
C
C
298	CONTINUE                           
	REWIND (42)
	REWIND (43)
C
C
C
C                                            
C
C
C	
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C			CONCENTRATOR INPUT
C
C
2	CONTINUE
C
C
200	CALL FDV$GET (AA,I,'H2O')
C
	READ (AA(1:4),'(F4.0)',ERR=200) H2O
C
	CALL FDV$GET (AA,I,'H2O3')
C
	READ (AA(1:4),'(F4.0)',ERR=200) H2O3
C
C
C
201	CALL FDV$GET (AA,I,'MAGFE')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 200
C
	READ (AA(1:4),'(F4.0)',ERR=201) RMF
C
	CALL FDV$GET (AA,I,'MAGFE3')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 201
C
	READ (AA(1:4),'(F4.0)',ERR=201) RMF3
C
C
202	CALL FDV$GET (AA,I,'RECOV')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 201
C
	READ (AA(1:4),'(F4.0)',ERR=202) DTR
C
	CALL FDV$GET (AA,I,'RECOV3')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 202
C
	READ (AA(1:4),'(F4.0)',ERR=202) DTR3
C
C
203	CALL FDV$GET (AA,I,'SIL')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 202
C
	READ (AA(1:5),'(F5.0)',ERR=203) DTS
C
	CALL FDV$GET (AA,I,'SIL3')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 203
C
	READ (AA(1:5),'(F5.0)',ERR=203) DTS3
C
C
204	CALL FDV$GET (AA,I,'INCH3')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 203
C
	READ (AA(1:6),'(F6.0)',ERR=204) P34
C
	CALL FDV$GET (AA,I,'INCH33')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 204
C
	READ (AA(1:6),'(F6.0)',ERR=204) P343
C
C
233	CALL FDV$GET (AA,I,'DTS')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 204
C
	READ (AA(1:6),'(F5.0)',ERR=233) TS
C
	CALL FDV$GET (AA,I,'DTS3')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 233
C
	READ (AA(1:6),'(F5.0)',ERR=233) TS3
C
C
205	CALL FDV$GET (AA,I,'HALF1')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 233
C
	READ (AA(1:4),'(F4.0)',ERR=205) PPX(1)
C
C
206	CALL FDV$GET (AA,I,'HALF2')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 205
C
	READ (AA(1:4),'(F4.0)',ERR=206) PPX(2)
C
C
207	CALL FDV$GET (AA,I,'HALF3')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 206
C
	READ (AA(1:4),'(F4.0)',ERR=207) PPX(3)
C
C
C
C
215	CALL FDV$GET (AA,I,'HALF13')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 207
C
	READ (AA(1:4),'(F4.0)',ERR=215) PPX3(1)
C
C
216	CALL FDV$GET (AA,I,'HALF23')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 205
C
	READ (AA(1:4),'(F4.0)',ERR=216) PPX3(2)
C
C
217	CALL FDV$GET (AA,I,'HALF33')
C
		IF (I .EQ. FDV$K_FT_PRV) GO TO 206
C
	READ (AA(1:4),'(F4.0)',ERR=217) PPX3(3)
C
C
	CALL FDV$GET (AA,I,'REPLY')
	CALL FDV$PUT (' ','REPLY')
C
	IF (AA(1:1) .EQ. 'Y' .OR. AA(1:1) .EQ. 'y') GO TO 9190
	IF (AA(1:1) .EQ. 'N' .OR. AA(1:1) .EQ. 'n') GO TO 200
	IF (AA(1:1) .EQ. 'A' .OR. AA(1:1) .EQ. 'a') GO TO 99
C
C
C	  check if 3/4" is within limits
C
C
9190	IF (P34 .LT. 85 .OR. P34 .GT. 99
	1	.OR. P343 .LT. 85 .OR. P343 .GT. 99) THEN
	  CALL FDV$PUT('THE %-3/4" IS OUT OF RANGE, IS THAT OK? (Y,N)','X')
		CALL FDV$GET (AA,I,'R2')
	  CALL FDV$PUT('                                             ','X')
		IF (AA(1:1) .EQ. 'Y' .OR. AA(1:1) .EQ. 'y') GO TO 8765
		GO TO 204
	END IF
ccccccccccccccccccccccccccccc
c
c
c
c
8765	IJ=0
	IJ3=0
	SUMH=0
	SUMH3=0
C
	DO 699 I=1,3
C
		IF (PPx(I) .LE. 0) GO TO 689
C
		SUMH=SUMH+PPx(I)
		IJ=IJ+1
C
C
689		IF (PPx3(I) .LE. 0) GO TO 699
C
		SUMH3=SUMH3+PPx3(I)
		IJ3=IJ3+1
C
699	CONTINUE
C
	IF (SUMH .LE. 0) THEN
		P12=0
		GO TO 2671
	ELSE
		P12=SUMH/IJ
	END IF
C
	IF (P12 .LT. 65 .OR. P12 .GT. 90) THEN
	 CALL FDV$PUT('THE AVG. %-1/2" IS OUT OF RANGE, IS THAT OK? (Y,N)','X')
		CALL FDV$GET (AA,I,'R2')
	CALL FDV$PUT('                                                  ','X')
		IF (AA(1:1) .EQ. 'Y' .OR. AA(1:1) .EQ. 'y') GO TO 267
		GO TO (205,206,207),I
	END IF
C
C
C
2671	IF (SUMH3 .LE. 0) THEN
		P123=0
		GO TO 267
	ELSE
		P123=SUMH3/IJ3
	END IF
C
	IF (P123 .LT. 65 .OR. P123 .GT. 90) THEN
	 CALL FDV$PUT('THE AVG. %-1/2" IS OUT OF RANGE, IS THAT OK? (Y,N)','X')
		CALL FDV$GET (AA,I,'R2')
	CALL FDV$PUT('                                                  ','X')
		IF (AA(1:1) .EQ. 'Y' .OR. AA(1:1) .EQ. 'y') GO TO 267
		GO TO (205,206,207),I
	END IF
C
C
C
CCCCCCCCCCCCCCCCCCCC
C
C	send shift +1/2 to HALFSIL.DAT for use by in-house stds. program
C
C
267	OPEN (UNIT=91,FILE='MET_P:HALFSIL2.DAT',STATUS='OLD',
	1	ACCESS='KEYED',SHARED)
C
c
	HSKEY(1:2)=AYSTR(10:11)
C
	DO 1011 I=1,12
		IF (MO(I) .EQ. AYSTR(4:6)) GO TO 313
1011	CONTINUE
C
	CALL FDV$PUTL('BO DATE')
	STOP
C
313	WRITE (HSKEY(3:4),'(I2)') I
	IF (HSKEY(3:3) .EQ. ' ') HSKEY(3:3)='0'
C
	READ (AYSTR(1:2),'(I2)') IID
C
	LMN=0
C
8333	READ (91,KEY=HSKEY,IOSTAT=M) HSD
C
	IF (.NOT.(M .EQ. 36 .OR. M .EQ. 0))THEN
		LMN=LMN+1
		IF (LMN .EQ. 6) GO TO 1798
		CALL LIB$WAIT (2.)
		GO TO 8333
		END IF
C
		DO 464 I=1,3
			HSD.CR12(I,IID)=0
			IF (PPX(I) .LE. 0 .AND. PPX3(I) .GT. 0)
	1			HSD.CR12(I,IID)=PPX3(I)
			IF (PPX(I) .GT. 0 .AND. PPX3(I) .LE. 0)
	1			HSD.CR12(I,IID)=PPX(I)
			IF (PPX(I) .GT. 0 .AND. PPX3(I) .GT. 0)
	1			HSD.CR12(I,IID)=(PPX(I)+PPX3(I))/2
464		CONTINUE

C
C
C
332	IF (M .EQ. 36) THEN
		WRITE (91) HSD
	ELSE
		REWRITE (91) HSD
	END IF
C
	CLOSE (91)
C
C
CCCCCCCCCCCCCCCCCCCC
C
C
1798	IF (NNN .NE. 0) GO TO 909
C
	REWIND (42)
	REWIND (43)
C
	BOIC(31)=H2O !
	BOIC(32)=RMF !

	BOIC(41)=P34 !
	BOIC(42)=P12 !
	BOIC(52)=TS
	BOIC(45)=DTR !
	BOIC(46)=DTS !
C
	HOIC(19)=H2O3 !
	HOIC(21)=P343 !
	HOIC(22)=P123 !
	HOIC(20)=RMF3 !
	HOIC(27)=TS3
C
	WRITE (42) BOIC
	WRITE (43) HOIC
c
	close (42)
	close (43)
C
C
c	save input data to file so it can be sent to Oracle database
C	after this program closes
c
	OPEN (UNIT=55,FILE='MET_P:CONC_TO_ORA.DAT',STATUS='UNKNOWN'
	1,err=909)
	REWIND (55)
	WRITE (55,550,err=909) AYSTR
	WRITE (55,551,err=909) H2O
	WRITE (55,551,err=909) H2O3
	WRITE (55,551,err=909) RMF
	WRITE (55,551,err=909) RMF3
	WRITE (55,551,err=909) P34
	WRITE (55,551,err=909) P343
	WRITE (55,551,err=909) P12
	WRITE (55,551,err=909) P123
	WRITE (55,551,err=909) DTR
	WRITE (55,551,err=909) DTS
C
550	FORMAT (1H ,A11)
551	FORMAT (1H ,F10.2)
C
	CLOSE (55)
C
C
909	IF (NNN .EQ. 0) THEN                              
C
		CALL LIB$SUBX (DAT,INTV,DAT,) ! increase date by 1 day
C
		WRITE (13,REC=1)DAT
C
	ELSE
		CALL LIB$DAY (INPDAY,INPDATE,)
		CALL LIB$DAY (IFDAY,DAT,)
		IF (INPDAY .GE. IFDAY) THEN
		CALL LIB$ADD_TIMES (INPDATE,INTV,DAT,) ! increase date by 1 day
		WRITE (13,REC=1)DAT
		END IF
	END IF
C
C
C
C
C
99	CALL FDV$LCLOS
	CALL FDV$SPADA (0)
	CALL FDV$DEL ('METINPUT')
	CALL FDV$DWKSP (%DESCR(WORKSPACE))
	CALL FDV$DTERM(%DESCR(TCA))
C
	STOP
C
C
C
C
	END
