CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C		FERROUS.FOR
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
	EXTERNAL UFO_OPEN
C
C
	INCLUDE 'FMS$EXAMPLES:FDVDEF'
Ccccccccccccccc
C
CCCCCCCCCCCCC
C
	INTEGER*2  KEYTABLE(24)/FDV$K_KF_NTR,FDV$K_KF_NONE,
	1		       	FDV$K_KF_NXT,FDV$K_KF_NONE,
	1		       	FDV$K_KF_PRV,FDV$K_KF_NONE,
	1			FDV$K_KF_SFW,FDV$K_KF_NONE,
	1			FDV$K_KF_SBK,FDV$K_KF_NONE,
	1		       	FDV$K_KF_NXT,107,
	1			fdv$k_kf_nxt,1037,
	1			fdv$k_kf_ntr,235,
	1			FDV$K_KF_NTR,269,
	1		       FDV$K_KF_NXT,FDV$K_AR_DOWN,
	1		       FDV$K_KF_PRV,FDV$K_AR_UP,	
	1		       FDV$K_KF_PRV,FDV$K_FK_F12/	
CCCCCCCCCCCCC
C
	INTEGER  WORKSPACE( 3 ),	!General workspace
	1	 CHECKWKSP( 3 ),	!Check workspace
	2	 TCA( 3 ),		!Terminal Control Area
    	3	 GASN_FORM(500),	!Storage for memory resident form
    	4	 GASD_FORM(750) 	!Storage for memory resident form
C
	integer flag/64/
C
 	DOUBLE PRECISION CT(18),FT(18),SCREEN(14,3,2,5),COMP(2,3,2,5),
	1  CAB(2,3,5),SIL(3,5),FILT2(5,3),BL2,FILT3(5,3),BL3,TOTAL,
	1  H2O,RMF,FTMF,BOIC(150),HOIC(150),CX(5),MX(5),AX(5),SX(5),
	1  FLUXG,P34,P12,FCA(2,3),FMG(2,3),FAL(2,3),FSI(2,3),
	1  PA(3,5),PC(3,5),PM(3,5),SCWT(3,2,5),
	1  TWT(5),BF(7,5),AF(7,5),TSW(5),TONS4(3,2,5),GHRS(3,2,5),
	1  COMP2(2,3,2,5)
C                                                                 
	INTEGER AMB(3),BMH(3),BD(2),YSTRDAY(2),NEW(3),LAST(3),
	1	IN,INO,DAT(2),INTV(2),IS,IS2,IS3,IH,STATUS,S4,H4
C
	DIMENSION ARD(8)
C
	CHARACTER PL(2)*2/'CN','AG'/,FN2*25,
	1	MO(12)*3/'JAN','FEB','MAR','APR',
	2	'MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'/
	3	,CAD*9,FILN*16,SH*2,TEMP*12,MINP,AINTV/'1'/,
	1	INAM(4)*6/'AMIOIC','BMIOIC',' AMBOP',' BMHOP'/,  
	1	PART(3)*16/'SCREEN FRACTIONS','       SIO2     ',
	2	'FILTER CAKE     '/,AYSTR*23,FILNAM*30,ASC2*3,
	1	PP1*29/'SCREEN FRACTIONS,COMPRESSIONS'/,KD*8,A5*5             
C
	CHARACTER SHED*32/'+5/8,+1/2,+3/8,+1/4,4M,+28M,-28M'/,
C
	2	CHED*38/'COMPRESSION AVG., -200 PCT.'/,
C
	2	BHED*18 /'AL203,CAO,MGO'/,
	2	BHEX*18 /'SIO2,AL203,CAO,MGO'/,
C
	3	FES*4/'SIO2'/,
C
	4	FILT*26/'SIO2,-270,-500,AL2O3,CAO,MGO'/,
C
	5	BAT(2)*6/'BEFORE','AFTER '/,
C
	1	MNTH(12)*3/'JAN','FEB','MAR','APR','MAY','JUN','JUL',
	1'AUG','SEP','OCT','NOV','DEC'/,TDAY*11,YDAY*11,KY*8,AD*23,
	1 KY8*8
C
	INTEGER D2,EXIST,LS,LH
C
	CHARACTER ASC*10,FULLDATE*23
C
C
C	   structure for GRAD1
C
	STRUCTURE /SCREEN1/
		UNION
			MAP
C
				CHARACTER SC*100
C
			END MAP
C
			MAP
				CHARACTER FE(5)*4,REPLY
			END MAP
C
		END UNION
C
	END STRUCTURE
C
C
	RECORD /SCREEN1/ MAP1
C
C
	REAL FEPLUS(5,3)
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
464	CALL FDV$ATERM( %DESCR(TCA),12 ,2)
	CALL FDV$AWKSP( %DESCR(WORKSPACE), 2000 )
	CALL FDV$LOPEN( 'user_d:[METREP.LAB45]FERROUS', 1 )
ccccc	call fdv$spada (0)
	CALL FDV$SPON ()
C
	CALL FDV$STIME (20)
C
	CALL FDV$DFKBD (%DESCR(KEYTABLE),12)
C                   
C
	CALL SYS$BINTIM (AINTV,INTV) !convert 24 hr interval to binary
C
C
	OPEN (11,FILE='USER_D:[METREP.LAB45]FERROUS.DAT',
	1	ACCESS='KEYED',STATUS='OLD',shared)
C
C
	AGL=0
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C       
C
C
C	 bring in LAB4.DAT to get date,shift, half in ascii of last entry
c
	OPEN (UNIT=10,FILE='USER_D:[METREP.LAB45]FEDATE.DAT',
	1STATUS='old',
	1ACCESS='DIRECT',FORM='FORMATTED',SHARED)
C
	GO TO 2655
C
cc255	CALL FDV$PUTL (' THE DATE,SHIFT,HALF FILE IS MISSING')
cc	CALL LIB$WAIT (30.)
cc	GO TO 99
C
2655	READ(10,55,REC=1)KY8,LS
C
55	FORMAT (A8,I1)
C
	KY=KY8
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C                
	IF (LS .EQ. 3) THEN
C
		AD(7:11)='-'//KY(1:4)
		READ (KY(5:6),'(I2)')MV
		AD(3:6)='-'//MNTH(MV)
		AD(1:2)=KY(7:8)
		ad(12:23)='            '
C
		CALL SYS$BINTIM (AD,BD)
		CALL LIB$ADD_TIMES (BD,INTV,BD)
		CALL SYS$ASCTIM (,AD,BD,)
		IF (AD(1:1) .EQ. ' ') AD(1:1)='0'
C
		DO 91 I=1,12           
			IF (MNTH(I) .EQ. AD(4:6)) GO TO 191
91		CONTINUE
C
C
		STOP ' MONTH ERROR'
C
191		WRITE (KY(5:6),'(I2)') I
		IF (KY(5:5) .EQ. ' ') KY(5:5)='0'
C
		
		KY(1:4)=AD(08:11)
		KY(7:8)=AD(1:2)
		KY8=KY
C
		LS=1
C
	ELSE
C
		LS=LS+1
C
C
	END IF
C
C
	IREPEAT=0	!0 says that no changes have been made
C
C
1	CALL FDV$CDISP ('FERROUS')
C
C
	AGL=1                           
C
	READ (11,KEY=KY,IOSTAT=MMM) KD,FEPLUS
C                                   
	NEWNEW=0
	IF (MMM .EQ. 36) NEWNEW=1
		KD=KY
		AD(7:11)='-'//KY(1:4)
		READ (KY(5:6),'(I2)')MV
		AD(3:6)='-'//MNTH(MV)
		AD(1:2)=KY(7:8)
		ad(12:23)='            '
		CALL SYS$BINTIM (AD,DAT)
C
	IF (MMM .EQ. 52) THEN
C
		CALL FDV$PUTL (' RECORD LOCKED')
		CALL LIB$WAIT (3.)
		GO TO 99
C
	END IF                                  
C
5959	ASC(1:2)=KY(5:6)
	ASC(3:4)=KY(7:8)
	ASC(5:6)=KY(3:4)
C
	CALL FDV$PUT (ASC(1:6),'DATE')
	WRITE (ASC,'(I1)') LS
	CALL FDV$PUT (ASC(1:1),'SHIFT')
C
C
8	CALL FDV$GETAL (MAP1.SC,LL,'FEPLUS',1)
c
	IF (map1.reply .eq. 'n' .or. map1.reply .eq. 'N') THEN
		CALL FDV$PUT (' ','REPLY')
		GO TO 8
	ELSE IF (map1.reply .eq. 'A' .or. map1.reply .eq. 'a') THEN
		go to 99
	ELSE IF (map1.reply .eq. 'y' .or. map1.reply .eq. 'Y') THEN
C
C
		DO 50 LINE=1,5
			READ (MAP1.FE(LINE), '(F4.2)') FEPLUS(LINE,LS) 
50		CONTINUE
C
		IF (MMM .EQ. 36) THEN
		WRITE (11) KD,FEPLUS
		ELSE IF (MMM .EQ. 0) THEN
		REWRITE (11) KD,FEPLUS
		END IF
C
		CLOSE (11)
C
	WRITE (10,55,REC=1) KY8,LS
	CLOSE (10)
CCCCCCCCCCCCCCCC
C
C	if it's 3rd shift, send the average data to the OIC files of
C	  the met reports.
C
	IF (LS .EQ. 3) THEN
C
c
C	I don't have room to store the data in amb so I won't do anything
C	until we start using the database.
c
		if (ls .eq. 3) go to 99
c
		OPEN (UNIT=42,FILE='MET_P:AMBOIC'//KD(7:8)//'.DAT',
	1		FORM='UNFORMATTED',STATUS='UNKNOWN',ERR=99)
C
C
		OPEN (UNIT=43,FILE='MET_P:BMHOIC'//KD(7:8)//'.DAT',
	1		FORM='UNFORMATTED',STATUS='UNKNOWN',ERR=99)
C
C
		READ (42,ERR=892)BOIC
C
892		READ (43,ERR=298)HOIC
C
C
298		CONTINUE                           
		REWIND (42)
		REWIND (43)
C
C
C
C
CCCCCC		WRITE (42) BOIC
CCCCCC		WRITE (43) HOIC
C
		CLOSE (42)
		CLOSE (43)
C
C
C
	END IF
C
CCCCCCCCCCCCCCCC	
C
	ELSE
		GO TO 99
	END IF

C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
99	CALL FDV$LCLOS
	CALL FDV$SPADA (0)
	CALL FDV$DEL ('LINEDATA')
	CALL FDV$DWKSP (%DESCR(WORKSPACE))
	CALL FDV$DTERM(%DESCR(TCA))
C
C
C
669	STOP
	END
