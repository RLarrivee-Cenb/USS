CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C	CONFIDENTIAL
C	Property of United States Steel Corporation
C	Copyright 2007 United States Steel Corporation
C	All rights reserved.
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
	PROGRAM		METAL
C
C	PROGRAM COUNTS THE NUMBER OF METAL TRIPS FOR EACH CRUSHER
C	CIRCUIT AND STUFFS THEM INTO THE ANVAL TABLE
C
C	ADDITION:  PROGRAM ALSO CALCULATES THE PCT MAG FE FOR CONCENTRATOR
C	LINES 3 THRU 18 AND STUFFS THEM INTO THE CONCENTRATOR ANVAL TABLE
C
C	ADDITION:  PROGRAM ALSO CALCULATES THE NUMBER OF TURNONS FOR 
C	PRI CRUSHER HYDROSET PUMPS AND STUFFS THEM INTO THE CRUSHER ANVAL TABLE
C
C	ADDITION:  PROGRAM ALSO CHECKS TO SEE IF THE LIMESTONE SCRUBBER IS
C	RUNNING AND IF IT IS, AFTER ONE HOUR OF CONTINUOUS RUNNING READS AND
C	SAVES THE BAGHOUSE AIR DIIFERENTIAL PRESSURE, THE SCRUBBER AIR
C	DIFFERENTIAL PRESSURE, AND THE SCRUBBER WATER FLOW SO THAT THE SCRUBBER
C	PROGRAM CAN SAVE THEM WHEN IT RUNS AT 22:30 
C
C	ADDITION:  PROGRAM ALSO CALCULATES THE NUMBER OF TURNONS FOR 
C	381-03-1 LIME FEEDER AND STUFFS IT INTO THE AGGLOMERATOR12 ANVAL TABLE
C	AS POINT 1120 PLANVIEW 60480 IM333059
C
C	LINK METAL,METAL/OPT
C
	IMPLICIT NONE
C
	INTEGER*4	SEC,TER,CXSTS(100),AG12CXSTS(100)
	INTEGER*4	I,J,K,L,M,N,TEMP,M60,AG12GPT(50)
	INTEGER*4	GPT(40),ADRS(2),BIT,BITX,CGPT(60)
	INTEGER*4	SECMET(15)/340,358,373,389,407,
	1			   453,471,485,499,516,
	1			   1042,964,1064,987,1083/
	INTEGER*4	SECMDS(15)/2279,2280,2281,2282,2283,
	1			   2284,2285,2286,2287,2288,
	1			   2289,2290,2291,2292,2293/
	INTEGER*4	TERMET(28)/542,743,557,758,574,773,590,
	1			   791,637,839,652,854,667,869,
	1			   682,884,1338,1155,1446,1275,1357,
	1			   1174,1465,1294,1376,1193,1484,1313/
	INTEGER*4	TERMDS(28)/2294,2295,2296,2297,2298,2299,2300,
	1			   2301,2302,2303,2304,2305,2306,2307,
	1			   2308,2309,2310,2311,2312,2313,2314,
	1			   2315,2316,2317,2318,2319,2320,2321/
	INTEGER*4	PMP1(4)/288,328,197,235/
	INTEGER*4	PMP2(4)/289,329,198,236/,LF/1535/
C
	INTEGER*4	MAGFE(16)/1567,1568,1569,1570,1571,1572,
	1			  1573,1574,1575,1576,1577,1578,
	1			  1579,1580,1581,1718/
C
	INTEGER*4	MAG(16)/161,189,207,237,255,283,
	1			303,330,350,388,411,451,
	1			471,506,526,144/
C
	INTEGER*4	NOR(16)/162,190,208,238,256,284,
	1			304,331,351,389,412,452,
	1			472,507,527,50/
C
	REAL*4		ANVAL(1000),CANVAL(1900),SAVX,TEMPX
	REAL*4		SCRUB(3),AG12ANVAL(1200)
C
	CHARACTER*8	TIM/'0 0:0:30'/	!30 SEC RUN TIME
C
	INTEGER*4	UFO_OPEN
C
	EXTERNAL	UFO_OPEN
C
	COMMON/CRS_ANVALTBL/ANVAL
	COMMON/CRS_GOODPTTBL/GPT
	COMMON/CONTACTSCRS/CXSTS	!CONTACT STATUS TABLE
	COMMON/CNC_ANVALTBL/CANVAL
	COMMON/CNC_GOODPTTBL/CGPT
	COMMON/ANVALTBL/AG12ANVAL	!AGGL12 ANALOG PULSE VALUE TABLE
	COMMON/GOODPTTBL/AG12GPT	!AGGL12 ANALOG PULSE GOODPOINT STATUS
	COMMON/CONTACTS/AG12CXSTS	!AGGL12 CONTACT STATUS TABLE
C
	CALL	SYS$BINTIM(TIM,ADRS)
	CALL	SYS$SCHDWK(,,ADRS,ADRS)	!SCHEDULE 30 SEC WAKEUP
C
100	CONTINUE
C
	OPEN	(UNIT=1,FILE='GP:METAL.DAT',ACCESS='DIRECT',
	1	FORM='UNFORMATTED',RECL=2,RECORDTYPE='FIXED',
	1	SHARED,STATUS='OLD',USEROPEN=UFO_OPEN)
C
	READ	(1,REC=1)SEC,TER
C
	DO 300	I=1,15	!PROCESS 15 SEC STAGE CRUSHERS
C
		L=(SECMET(I)/32)+1	!EXTRACT CXSTS LONGWORD
		M=MOD(SECMET(I),32)	!EXTRACT CORRECT BIT
		BIT=JIBITS(CXSTS(L),M,1)	!EXTRACT BIT CONDITION
C
		IF (BIT .EQ. 1)THEN             !IF METAL DETECT NORMAL
			SEC=JIBCLR(SEC,I)	!RESET METAL ALARM BIT
			ANVAL(730+I-1)=0	!ZERO ANVAL
			GOTO 200		!INDEX TO NEXT CRUSHER
		ELSE
			L=(SECMDS(I)/32)+1	!CXSTS LONGWORD
			M=MOD(SECMDS(I),32)	!CORRECT BIT
			BIT=JIBITS(CXSTS(L),M,1)!BIT CONDITION
C
			IF (BIT .EQ. 0)THEN	!IF MDS IS DISABLED
				SEC=JIBCLR(SEC,I)	!RESET ALARM
				ANVAL(730+I-1)=0
				GOTO 200		!INDEX
			ELSE
				BIT=JIBITS(SEC,I,1)
				IF (BIT .EQ. 1)THEN	!ALREADY IN ALARM
					ANVAL(730+I-1)=0!ONLY COUNT IT ONCE
					GOTO 200
				ELSE
					ANVAL(730+I-1)=1!COUNT THE ALARM
					SEC=JIBSET(SEC,I)!SET THE ALARM IND
					GOTO 200
				END IF
    			END IF
		END IF
C
200		CONTINUE
C
		TEMP=730+I-1	!SET GOODPT FOR THIS POINT
		M=(TEMP/32)+1
		N=MOD(TEMP,32)
		GPT(M)=JIBSET(GPT(M),N)
C
300	CONTINUE
C
	DO 500	I=1,28	!PROCESS 28 TER STAGE CRUSHERS
C
		L=(TERMET(I)/32)+1	!EXTRACT CXSTS LONGWORD
		M=MOD(TERMET(I),32)	!EXTRACT CORRECT BIT
		BIT=JIBITS(CXSTS(L),M,1)	!EXTRACT BIT CONDITION
C
		IF (BIT .EQ. 1)THEN             !IF METAL DETECT NORMAL
			TER=JIBCLR(TER,I)	!RESET METAL ALARM BIT
			ANVAL(745+I-1)=0	!ZERO ANVAL
			GOTO 400		!INDEX TO NEXT CRUSHER
		ELSE
			L=(TERMDS(I)/32)+1	!CXSTS LONGWORD
			M=MOD(TERMDS(I),32)	!CORRECT BIT
			BIT=JIBITS(CXSTS(L),M,1)!BIT CONDITION
C
			IF (BIT .EQ. 0)THEN	!IF MDS IS DISABLED
				TER=JIBCLR(TER,I)	!RESET ALARM
				ANVAL(745+I-1)=0
				GOTO 400		!INDEX
			ELSE
				BIT=JIBITS(TER,I,1)
				IF (BIT .EQ. 1)THEN	!ALREADY IN ALARM
					ANVAL(745+I-1)=0!ONLY COUNT IT ONCE
					GOTO 400
				ELSE
					ANVAL(745+I-1)=1!COUNT THE ALARM
					TER=JIBSET(TER,I)!SET THE ALARM IND
					GOTO 400
				END IF
    			END IF
		END IF
C
400		CONTINUE
C
		TEMP=745+I-1	!SET GOODPT FOR THIS POINT
		M=(TEMP/32)+1
		N=MOD(TEMP,32)
		GPT(M)=JIBSET(GPT(M),N)
C
500	CONTINUE
C
	DO 700 I=1,4	!PROCESS HYDROSET PUMPS FOR EACH PRIMARY CRUSHER
C
		L=(PMP1(I)/32)+1	!EXTRACT CXSTS LONGWORD PUMP#1
		M=MOD(PMP1(I),32)	!EXTRACT CORRECT BIT
		BIT=JIBITS(CXSTS(L),M,1)	!EXTRACT BIT CONDITION
C
		L=(PMP2(I)/32)+1	!EXTRACT CXSTS LONGWORD PUMP#2
		M=MOD(PMP2(I),32)	!EXTRACT CORRECT BIT
		BITX=JIBITS(CXSTS(L),M,1)	!EXTRACT BIT CONDITION
C
		BIT=BIT+BITX	!ADD RESULTS
C
		IF (BIT .EQ. 0)THEN	!IF NEITHER PUMP IS RUNNING
			SEC=JIBCLR(SEC,I+15)	!RESET PUMP  BIT
			ANVAL(915+I-1)=0	!ZERO ANVAL
			GOTO 600
		ELSE
			BIT=JIBITS(SEC,I+15,1)
			IF (BIT .EQ. 1)THEN	!PUMP ALREADY ON
				ANVAL(915+I-1)=0	!ONLY COUNT IT ONCE
				GOTO 600	
			ELSE
				ANVAL(915+I-1)=1	!COUNT THE TURNON
				SEC=JIBSET(SEC,I+15)	!SET THE IND BIT
				GOTO 600
			END IF
		END IF
C
600		CONTINUE
C
		TEMP=915+I-1
		M=(TEMP/32)+1
		N=MOD(TEMP,32)
		GPT(M)=JIBSET(GPT(M),N)
C
700	CONTINUE
C
C	PROCESS 381-03-1 LIME FEEDER
C
		L=(LF/32)+1		!EXTRACT CXSTS LONGWORD LIME FEEDER
		M=MOD(LF,32)		!EXTRACT CORRECT BIT
		BIT=JIBITS(AG12CXSTS(L),M,1)	!EXTRACT BIT CONDITION
C
		IF (BIT .EQ. 0)THEN	!IF BIT IS OFF  FEEDER IS NOT RUNNING
			SEC=JIBCLR(SEC,20)	!RESET FEEDER  BIT
			AG12ANVAL(1120)=0	!ZERO ANVAL
			GOTO 666
		ELSE
			BIT=JIBITS(SEC,20,1)
			IF (BIT .EQ. 1)THEN	!FEEDER ALREADY ON
				AG12ANVAL(1120)=0	!ONLY COUNT IT ONCE
				GOTO 666	
			ELSE
				AG12ANVAL(1120)=1	!COUNT THE TURNON
				SEC=JIBSET(SEC,20)	!SET THE IND BIT
				GOTO 666
			END IF
		END IF
C
666		CONTINUE
C
		TEMP=1120
		M=(TEMP/32)+1
		N=MOD(TEMP,32)
		AG12GPT(M)=JIBSET(AG12GPT(M),N)
C
	WRITE	(1,REC=1)SEC,TER
C
	CLOSE	(UNIT=1)
C
	DO 900	I=1,16
C
		TEMP=1567+I-1
		IF (I .EQ. 16)TEMP=1718
		M=(TEMP/32)+1
		N=MOD(TEMP,32)
C
		TEMPX=CANVAL(NOR(I))	!LOAD TAC TONS
C
		IF (TEMPX .LE. 0)THEN
			CGPT(M)=JIBCLR(CGPT(M),N)
			GOTO 900	
		END IF
C
		SAVX=(CANVAL(MAG(I))/TEMPX)*100	!CALCULATE MAG FE
C
C		IF (I .EQ. 12)SAVX=19.4
C
		IF ((SAVX .GE. 10).AND.(SAVX .LE. 40))THEN
			CANVAL(MAGFE(I))=SAVX	!STUFF NEW MAG FE
			CGPT(M)=JIBSET(CGPT(M),N)
		ELSE
			CGPT(M)=JIBCLR(CGPT(M),N)
		END IF
C
900	CONTINUE
C
	L=(1314/32)+1	!EXTRACT CXSTS LONGWORD 078-03-19G1
	M=MOD(1314,32)	!EXTRACT CORRECT BIT
	BIT=JIBITS(CXSTS(L),M,1)	!EXTRACT BIT CONDITION
C
	IF (BIT .EQ. 1)THEN
		M60=M60+1		!IF FAN ON BUMP COUNTER
	ELSE
		M60=0
	END IF
C
	IF (M60 .EQ. 120)THEN	!IF ONE HOUR OF CONTINUOUS RUNNING
C
		OPEN	(UNIT=2,FILE='ANA:BAGH.DAT',STATUS='OLD',
	1		RECL=3,ACCESS='DIRECT',RECORDTYPE='FIXED',
	1		FORM='UNFORMATTED',SHARED,USEROPEN=UFO_OPEN)
C
		SCRUB(1)=ANVAL(498)	!BAGHOUSE AIR DIFF PRESS
		SCRUB(2)=ANVAL(501)	!SCRUBBER AIR DIFF PRESS
		SCRUB(3)=ANVAL(500)	!SCRUBBER WATER FLOW
		WRITE	(2,REC=1)SCRUB	!WRITE OUT RESULTS
C
		CLOSE	(UNIT=2)
C
	END IF
C
	CALL	SYS$HIBER()	!DELAY TILL WAKEUP
	GOTO 100
C
	END
