C
	PROGRAM		CEM
C
C	THIS PROGRAM RUNS EVERY 30 SECONDS AND MAINTAINS A ROLLING 
C	ONE HOURS WORTH OF NOx PRODUCTION AND BTU CONSUMPTION FOR
C	LINE 7 AGGLOMERATOR DURING NORMAL PELLET PRODUCTION.  THE 
C	PROGRAM CHECKS TO SEE IF THE GRATE IS RUNNING AND THE STACK 
C	CAP IS CLOSED AND THEN ADDS A NEW 30 ENTRY TO THE TABLE.
C
	IMPLICIT NONE
C
	INTEGER*4	I,J,UFO_OPEN,M,N
	INTEGER*4	ADRS(2),CAP/261/,MAXON/425/
	INTEGER*4	CXSTSAG3(100),BIT,GRATE/356/,MBTU/879/
	INTEGER*4	NOXC/642/,NOXF/643/,F3A/276/,KET/278/
	INTEGER*4	GPTX(40)
C
	REAL*8		NOX(120),BTU(120)
	REAL*4		ANVAL(1000)
C
	CHARACTER*23	DATEX(120)
	CHARACTER*8	TIM/'0 0:0:30'/	!30 SEC RUN TIME
C
	STRUCTURE      /CEMR/
		CHARACTER*23	SDATEX
		CHARACTER*23	EDATEX
		REAL*8		TIM
		REAL*8		NOX
		REAL*8		MBTU
		REAL*8		HNOX
		REAL*8		HMBTU
		REAL*8		MAF(2)
		REAL*8		GSC(2)
	END STRUCTURE
C
	RECORD/CEMR/CEMR
C
	COMMON/CONTACTSAG3/CXSTSAG3	!CONTACT STATUS TABLE
	COMMON/AG3_ANVALTBL/ANVAL
	COMMON/AG3_GOODPTTBL/GPTX
C
	EXTERNAL	UFO_OPEN
C
	CALL	SYS$BINTIM(TIM,ADRS)
	CALL	SYS$SCHDWK(,,ADRS,ADRS)	!SCHEDULE 30 SEC WAKEUP
C
100	CONTINUE
C
	ANVAL(908)=(ANVAL(NOXC)*ANVAL(NOXF)*0.007164)/120 !30 SECONDS OF NOx
	M=(908/32)+1
	N=MOD(908,32)
	GPTX(M)=JIBSET(GPTX(M),N) 	!SET GOODPT FOR WG STACK NOx
C
	I=(GRATE/32)+1		!WORD IN TABLE
	J=MOD(GRATE,32)		!BIT IN WORD
	BIT=JIBITS(CXSTSAG3(I),J,1)!EXTRACT BIT
C
	IF (BIT .EQ. 0)GOTO 4444		!GRATE IS OFF
	IF (ANVAL(CAP) .GT. 10.0)GOTO 4444       !CAP IS OPEN
C
C	WE HAVE NORMAL PELLET PRODUCTION.... GRATE ON, CAP CLOSED
C
	OPEN	(UNIT=1,FILE='ANA:CEM.DAT',STATUS='OLD',
	1	RECL=1200,RECORDTYPE='FIXED',FORM='UNFORMATTED',
	1	ACCESS='DIRECT',USEROPEN=UFO_OPEN,SHARED)
C
	READ	(1,REC=1)NOX,BTU,DATEX
C
	DO 200	I=119,1, -1	!SHUFFLE TABLE DOWN TO MAKE ROOM FOR NEW
		NOX(I+1)=NOX(I)	!30 SECOND ENTRY
		BTU(I+1)=BTU(I)
		DATEX(I+1)=DATEX(I)
200	CONTINUE
C
	CALL	LIB$DATE_TIME(DATEX(1))	!GET CURRENT TIME
	BTU(1)=ANVAL(MBTU)/120000	!30 SECONDS WORTH OF MMBTUS	
	NOX(1)=(ANVAL(NOXC)*ANVAL(NOXF)*0.007164)/120 !30 SECONDS OF NOx
C
	WRITE	(1,REC=1)NOX,BTU,DATEX	!SEND RESULTS BACK
C
	CLOSE	(UNIT=1)
C
	ANVAL(906)=0 !3A MASS FLOW
	M=(906/32)+1
	N=MOD(906,32)
	GPTX(M)=JIBSET(GPTX(M),N) 	!SET GOODPT FOR 3A MASS FLOW
C
	ANVAL(907)=0 !CALC LBS OF NOx
	M=(907/32)+1
	N=MOD(907,32)
	GPTX(M)=JIBSET(GPTX(M),N) 	!SET GOODPT FOR LBS OF NOx
C
	OPEN	(UNIT=1,FILE='ANA:CEMX.DAT',STATUS='OLD',
	1	RECL=30,RECORDTYPE='FIXED',FORM='UNFORMATTED',
	1	ACCESS='DIRECT',USEROPEN=UFO_OPEN,SHARED)
C
	READ	(1,REC=1)CEMR	!READ IN CURRENT CAP OPEN RECORD
C
	CLOSE	(UNIT=1)
C
	IF (CEMR.SDATEX .EQ. '                       ')GOTO 9999	!NOTHING TO DO
C
8888	CONTINUE
C
	CEMR.EDATEX=DATEX(1)	!INDICATE END OF PERIOD
C
	OPEN	(UNIT=1,FILE='ANA:CEMX.DAT',STATUS='OLD',
	1	RECL=30,RECORDTYPE='FIXED',FORM='UNFORMATTED',
	1	ACCESS='APPEND',USEROPEN=UFO_OPEN,SHARED)
C
	WRITE	(1)CEMR	!APPEND NEW RECORD TO END OF FILE
C
	CLOSE	(UNIT=1)
C
	CEMR.SDATEX='                       '
	CEMR.EDATEX='                       '
	CEMR.TIM=0
	CEMR.NOX=0
	CEMR.MBTU=0
	CEMR.HNOX=0
	CEMR.HMBTU=0
	CEMR.MAF(1)=0
	CEMR.MAF(2)=0
	CEMR.GSC(1)=0
	CEMR.GSC(2)=0
C
	OPEN	(UNIT=1,FILE='ANA:CEMX.DAT',STATUS='OLD',
	1	RECL=30,RECORDTYPE='FIXED',FORM='UNFORMATTED',
	1	ACCESS='DIRECT',USEROPEN=UFO_OPEN,SHARED)
C
	WRITE	(1,REC=1)CEMR	!CLEAR CURRENT CAP OPEN RECORD
C
	CLOSE	(UNIT=1)
C
	GOTO 9999
C
4444	CONTINUE
C
	I=(MAXON/32)+1		!WORD IN TABLE
	J=MOD(MAXON,32)		!BIT IN WORD
	BIT=JIBITS(CXSTSAG3(I),J,1)!EXTRACT BIT
C
	OPEN	(UNIT=1,FILE='ANA:CEMX.DAT',STATUS='OLD',
	1	RECL=30,RECORDTYPE='FIXED',FORM='UNFORMATTED',
	1	ACCESS='DIRECT',USEROPEN=UFO_OPEN,SHARED)
C
	READ	(1,REC=1)CEMR	!READ CURRENT CAP OPEN RECORD
C
	IF (BIT .EQ. 0)THEN	!KILN BURNER IS OFF (LINE IS DOWN)
C
		ANVAL(906)=0 !3A MASS FLOW
		M=(906/32)+1
		N=MOD(906,32)
		GPTX(M)=JIBSET(GPTX(M),N) 	!SET GOODPT FOR 3A MASS FLOW
C
		ANVAL(907)=0 !CALC LBS OF NOx
		M=(907/32)+1
		N=MOD(907,32)
		GPTX(M)=JIBSET(GPTX(M),N) 	!SET GOODPT FOR LBS OF NOx
C
		IF (CEMR.SDATEX .EQ. '                       ')THEN
			CLOSE	(UNIT=1)	!CURRENT RECORD EMPTY
			GOTO 9999               !NO WORK TO DO
		END IF
C
		CLOSE	(UNIT=1)
		CALL	LIB$DATE_TIME(DATEX(1))	!GET CURRENT TIME
		GOTO 8888	!GO CLEANUP CURRENT CAP RECORD
C
	END IF
C
	CEMR.TIM=CEMR.TIM+30		!ADD 30 SECONDS TO TIME CAP IS OPEN
	CEMR.MBTU=CEMR.MBTU+ANVAL(MBTU)/120000	!30 SECONDS WORTH OF MMBTUS	
	CEMR.MAF(1)=CEMR.MAF(1)+
	1		(((116.52*ANVAL(F3A))-635.77)/2000)! 3A MASS FLOW
	CEMR.MAF(2)=CEMR.MAF(2)+1	!BUMP OBSERVATIONS
	CEMR.GSC(1)=CEMR.GSC(1)+ANVAL(KET)	!STACK CAP TEMP
	CEMR.GSC(2)=CEMR.GSC(2)+1	!BUMP OBSERVATIONS
C
	IF (CEMR.SDATEX .EQ. '                       ')THEN
		CALL	LIB$DATE_TIME(CEMR.SDATEX) !START OF OPEN CAP PERIOD
	END IF
C
	OPEN	(UNIT=2,FILE='ANA:CEM.DAT',STATUS='OLD',
	1	RECL=1200,RECORDTYPE='FIXED',FORM='UNFORMATTED',
	1	ACCESS='DIRECT',USEROPEN=UFO_OPEN,SHARED)
C
	READ	(2,REC=1)NOX,BTU,DATEX
C
	CLOSE	(UNIT=2)	
C
	CEMR.HNOX=0
	CEMR.HMBTU=0
C
	DO 444	I=1,120
		CEMR.HNOX=CEMR.HNOX+NOX(I)	!LBS OF NOx LAST GOOD HOUR
		CEMR.HMBTU=CEMR.HMBTU+BTU(I)      !MMBTUs LST GOOD HOUR
444	CONTINUE
C
	IF (CEMR.HMBTU .EQ. 0)THEN
	CEMR.NOX=0
	ELSE
	CEMR.NOX=(CEMR.HNOX/CEMR.HMBTU)*CEMR.MBTU	!CALC LBS OF NOx
	END IF
C
	WRITE	(1,REC=1)CEMR	!UPDATE CAP OPEN RECORD
C
	CLOSE	(UNIT=1)
C
	ANVAL(906)=(((116.52*ANVAL(F3A))-635.77)/2000)!3A MASS FLOW
	M=(906/32)+1
	N=MOD(906,32)
	GPTX(M)=JIBSET(GPTX(M),N) 	!SET GOODPT FOR 3A MASS FLOW
C
	ANVAL(907)=(CEMR.HNOX/CEMR.HMBTU)*(ANVAL(MBTU)/120000)!CALC LBS OF NOx
	M=(907/32)+1
	N=MOD(907,32)
	GPTX(M)=JIBSET(GPTX(M),N) 	!SET GOODPT FOR LBS OF NOx
C
9999	CONTINUE
C
	CALL	SYS$HIBER()
	GOTO 100
C
	END
C
