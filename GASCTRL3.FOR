CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C                                                                   C
C                                                                   C
C                     GASCTRL3_BED.FOR                              C
C                                                                   C
C                     RJM 02-MAR-1998                               C
C
C	LINK GASCTRL3_BED,FULLAG3/OPT,WESAPI_LIB:WESAPI/OPT
C                                                                   C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	 THIS PROGRAM CONTROLS THE MAIN GAS VALVE AND COAL BELT 
C       AT THE STEP 3 AGGLOMERATOR 
C
C
C	REVISION HISTORY
C
C	SERVICE CENTER TICKET PM649418 4-9-2007
C	ADDED CODE TO OUTPUT GAS PELLET TEMERATURE SETPOINT BY LINE TO
C	WDPF HIGHWAY PER CHAD STEWART
C
	PROGRAM GASCTRL3_BED
C
	INTEGER UFO_OPEN
	EXTERNAL UFO_OPEN
	EXTERNAL CLI$M_NOWAIT
C
	INCLUDE '($PRCDEF)'
	INCLUDE '($SSDEF)'
	INCLUDE 'WESAPI:SPD.DCL'
	INCLUDE 'WESAPI:SHC_DEFINES.DCL'
	INCLUDE 'WESAPI:SHC_ERR.DCL'
C
C
	REAL KESPAN/2500./,BZSPAN/1000./
C
C
	STRUCTURE	/AM/
	INTEGER*2	ID,AS
	REAL*4		AV
	BYTE		RT,FM,SR,LU
	INTEGER*2	AW,DG
	CHARACTER*8	PN
	INTEGER*2	TB,BB
	END STRUCTURE
C
	RECORD/AM/SYSAOS,AOS(80),SYSAOS3,AOS3(80)   !ANALOG OUTPUT TABLE
C
C
	INTEGER TOTNUM/1800/    !TOTAL NO. OF POINTS IN KE AVG TABLE
C
	REAL 	OBAS(2),RESET(2),GAIN(2),DERIV(2),OUTPUT(2),GFAVG(2),
	1	KOBAS(2),KRESET(2),KGAIN(2),KDERIV(2),
	1	MAXG(2),MAXC(2),MAXKE(2),MINGV(2),KMINUTES(2),KEUP(2),
	1	KETIME(2),PELTEMP(2),PELSTPT(2),
	1	BZOBAS(2),PRESET(2),PGAIN(2),BSET(2),
	1	GASFLO
C
	INTEGER ONGAS(2),DUST(2),ONCOAL(2),GNUM(2),DUSTCOUNT(2),DUSTLIM(2),
	1 PELT(2)
C
C
C
	REAL 	GFNUMS(2,1800),TEMP_INCREASE(2),TVAL
C
C
	LOGICAL BZ_HIGH
C
	REAL NBAS
C
C
	REAL ANVAL3(1000)
C
C
CCCC patch	INTEGER TIMER(2),SYS$BINTIM,SYS$SCHDWK,SYS$HIBER,
	INTEGER TIMER(2),SYS$BINTIM,SYS$SCHDWK,
	1	GOODPT3(40)
C
C
	INTEGER*2 BO,CXOUT(40),BO3,CXOUT3(40)
c
	INTEGER GOOD(33)
C
C
	LOGICAL STAT
C
C
	CHARACTER*6 ALARM /'0 ::02'/
C
	REAL BZTEMP,KEXIT,BZSTPT
C
	INTEGER ONCTL(2),KEAN(2),GVAN(2),WGAS(2),BZAN(2),ONGASCX(2),
	1BZSP(2),KESP(2),BEDAN(2),PSPAN(2),GFAN(2)
C
C                        DIGITAL INPUT POINTS
C
	DATA	ONCTL		/1,2/,	! on/off HEATUP control
	1	ONGASCX 	/3,4/,	! on/off gas control
	1	WGAS    	/5,6/	! ON/OFF WASTE GAS FAN
C
C                       
	DATA	KEAN	/7,8/, 		!kiln exit temp. analog
	1	BZAN    /9,10/,      	!burn zone temp
	1	GVAN	/11,12/,   	!gas valve position analog
	1	BZSP	/13,14/,        !burn zone setpoint
	1	KESP	/15,16/,        !kiln exit setpoint
	1	PELT	/20,21/,	!pellet bed temperature
	1	PSPAN	/22,23/,	!pellet set point
	1	GFAN	/24,25/		!gas flow mcf
C
C
C	ON CONTROL DO IS DV800001 (17)
C	OUTPUTS TO GAS VALVES ARE AV800001 & AV800002 (18,19)
C
C
C
	REAL	TC 	!SPANS FOR BZ AND KE ANALOGS
C
C
CCCCCCCC	REAL BZSETPNT,KESETPNT
	REAL KESETPNT
C
C
	INTEGER BOBZ
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
cccccccccccccccccccccccccccccccccccccccccccccccccccccc
C
C
C
	INTEGER*4	LIB$SYS_TRNLOG
	INTEGER*4	i
	CHARACTER*10 	choice
	INTEGER*4 	status
	CHARACTER*20	highway

	CHARACTER*40    spd_filename
	INTEGER*2	spd_filename_len
	INTEGER*2	spd_fd
	INTEGER*2	access_type
C
	integer		sid
C
C  Case 2 variables
	REAL		get_analog_val
	INTEGER*2	get_analog_stat
C
C
C  Case 3 variables
	INTEGER*4       gp_sid
	BYTE		gp_bitnum 
	INTEGER*2	digital_val
	INTEGER*2	digital_stat
c
c
	BYTE		extended_flag
	BYTE		gp_bit_num
        BYTE		inactive_flag
c
C	CASE 7 VARIABLES
	REAL		put_analog_val
c
C	CASE 8 VARIABLES
	INTEGER*2	put_digital_val
c
c	CASE 45 VARIABLES
	INTEGER*4	point_quality
	INTEGER*4	quality_stat
c
c
	CHARACTER APT*8
	INTEGER SYSID(33),DIGV
	integer*2 CXSTS(33)
	REAL ANVAL(33)
c
C
C                              
C                                                      
C
C
	COMMON /GAS3/ OBAS,RESET,GAIN,DERIV,GFAVG,KOBAS,
	1	KRESET,KGAIN,KDERIV,ONGAS,ONCOAL,DUST,GNUM,
	1	DUSTCOUNT,DUSTLIM,MAXG,MAXC,OUTPUT,MAXKE,MINGV,
	1	KMINUTES,KEUP,KETIME,PELSTPT,PELTEMP,
	1	BZOBAS,PRESET,PGAIN,BSET
C
C
cccccccccccccccccccccccccccccccccccccccccccccccccccccc
C
C
	STAT(m)=bitest (cxsts(m),0)
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C  Use the wesapi highway number to form the name of the wesapi logical that
C  names the point directory file and get the file name from the logical
C
           status = LIB$SYS_TRNLOG('WESAPI_PDIR_1',
	1		spd_filename_len,spd_filename,,,)
C
        IF (status .NE. SS$_NORMAL) THEN
	   PRINT *, '  Logical WESAPI_PDIR not defined'
	   stop 'no point dir'
        ENDIF
C
C
C
C  Put a NULL character (0) at the end of the file name string.  This is
C  necessary because the spd library functions expect string arguments
C  to be NULL terminated strings.
	spd_filename(spd_filename_len+1:) = CHAR(0)

C  Call the spd open file function to get access to the point directory file
        access_type = RUNTIME
        spd_fd = SPD_open_file(%ref(spd_filename), access_type)
        IF (spd_fd .LT. 0) THEN
           PRINT *,'  SPD_open_file() Error : ',spd_fd
           STOP
  	ENDIF
C
C
C
C
C
C	  READ IN ANALOG POINT NOS. FROM GASCTRL.SRC
C
	OPEN (UNIT=50,FILE='USER_D:[RJM]GASCTRL3.SRC',STATUS='OLD',
	1	SHARED,READONLY)
C
	JJ=0
	KK=1
C
	DO WHILE (JJ .EQ. 0)
54		READ (50,55,IOSTAT=JJ,err=552) APT
55		FORMAT (A)
		IF (APT(1:1) .LT. '0') GO TO 54
c
c
C  Call the get sid function.  The point name argument must have a NULL (0)
C  at the end.
           status = SPD_get_sid(spd_fd, %ref(apt//char(0)), sid,
	1		gp_sid, gp_bit_num, extended_flag, inactive_flag)
c
	SYSID(KK)=SID
	KK=KK+1
c
	END DO
C
552	CLOSE (50) 	!CLOSE GASCTRL3.SRC FILE
c
C  Close the point directory file 
           status = SPD_close_file(spd_fd)
           IF (status .NE. 0) THEN
    	      PRINT *,'  SPD_close_file() Error : ', status
	      STOP
	   ENDIF
c
c
	status = SHC_open_memory()
c	IF (status .NE. SHC_OK) THEN
c	   PRINT *,' SHC open memory failure - error = ',status
c	   STOP
c	ENDIF
c
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C	ALL SIDS' ARE IN SYSID(25)
C
C	SYSID(1-6) CI;  SYSID(7-16) AI;  SYSID(17) CO;  SYSID(18-19) AO
C
C	SYSID(20,25) PEL SETPT,PEL TEMP, AND GASFLO ANALOGS
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C
C
C	SCHEDULING A 2 SECOND WAKEUP REQUEST
C
C       CONVERT ASCII TIME TO BINARY
C
	STATUS=SYS$BINTIM (ALARM,TIMER)   
C
C	SCHEDULE WAKEUP
C
	STATUS=SYS$SCHDWK (,,TIMER,TIMER)
C
C
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C
C	FILL THE GAS3 COMMON WITH THE DATA IN GAS3.DAT WHEN THE PROGRAM
C	IS RESTARTED ONLY!
C
C
 	OPEN (UNIT=11,FILE='D_I:GAS3.DAT',STATUS='UNKNOWN',
	1	FORM='UNFORMATTED',RECL=100,ACCESS='DIRECT',
	1	RECORDTYPE='FIXED'
	2	,SHARED,USEROPEN=UFO_OPEN)
C                                    
C
	READ (11,REC=1)OBAS,RESET,GAIN,DERIV,GFAVG,KOBAS,
	1	KRESET,KGAIN,KDERIV,ONGAS,ONCOAL,DUST,GNUM,
	1	DUSTCOUNT,DUSTLIM,MAXG,MAXC,OUTPUT,MAXKE,MINGV,
	1	KMINUTES,KEUP,KETIME,PELSTPT,PELTEMP,
	1	BZOBAS,PRESET,PGAIN,BSET
C
	CLOSE (11)
C
C
C
C
C
C
C
C
C	toggle contact output no. 1 to keep STEP 3 GAS on control
C
C
1	status = SHC_get_digital_val_stat( SYSID(17), gp_sid, gp_bitnum,
	1		digital_val, digital_stat)
C
			IF (DIGITAL_VAL) THEN
				PUT_DIGITAL_VAL=0
			ELSE
				PUT_DIGITAL_VAL=1
			END IF
C
	POINT_QUALITY=0
	STATUS=SHC_PUT_POINT_QUALITY (SYSID(17),POINT_QUALITY)
c
	status=shc_put_digital_val (sysid(17),put_digital_val)
C
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	READ IN THE ANALOG VALUES FROM GASCTRL3.SRC EVERY SCAN
C
C
	DO 300 J=7,16
	STATUS=SHC_GET_ANALOG_VAL_STAT (SYSID(J),GET_ANALOG_VAL,
	1	GET_ANALOG_STAT)
C
	GOOD(J)=1
	IF (bitest(get_analog_stat,8)
	1 .or. bitest(get_analog_stat,9) .or. bitest(get_analog_stat,15))
	1	GOOD(J)=0
C
C
	ANVAL(J)=GET_ANALOG_VAL
C
C
300	CONTINUE
C
C
C	read in the PELLET AND GASFLO values
C
	DO 1300 J=20,25
	STATUS=SHC_GET_ANALOG_VAL_STAT (SYSID(J),GET_ANALOG_VAL,
	1	GET_ANALOG_STAT)
C
	GOOD(J)=1
	IF (bitest(get_analog_stat,8)
	1 .or. bitest(get_analog_stat,9) .or. bitest(get_analog_stat,15))
	1	GOOD(J)=0
C
C
	ANVAL(J)=GET_ANALOG_VAL
C
C
1300	CONTINUE
C
C
CCCCCCCCCCCCCCC
C
C
C	READ IN CONTACT VALUES
C
	DO 301 J=1,6
C
	gp_sid=0
	gp_bitnum=0  
	status = SHC_get_digital_val_stat( SYSID(J), gp_sid, gp_bitnum,
	1		digital_val, digital_stat)
C
C
	CXSTS(J)=DIGITAL_VAL
C
C
301	CONTINUE
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C       
C
C                      
C
C
C	DO 2000 LINE=1,2	!main loop to do lines 6 and 7
	DO 2000 LINE=1,1	!ONLY 6, LINE 7 HAS NEW LOW NOX BURNER
C
	BOBZ=0
C
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C		convert no. of minutes requested to average the GAS FLOW
C		with: (kminutes) to
C		no. of points. ((kminutes*60 sec.)/2)  where 2 is the scan
C		rate in seconds.
C
C
	NOP=KMINUTES(LINE)*60/2
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C
C
	IF (STAT(ONCTL(LINE))) GO TO 2000 	!SEE IF HEATUP IS ON
C
C
C
C
C
C  	CHECK ALL ANALOGS
C
	ANOK=0
C
ccccccccccc   patch 9-11-00
cccc	IF (GOOD(KEAN(LINE))) THEN
C
cccc		KEXIT = ANVAL(KEAN(LINE))
cccc	ELSE
cccc		CALL ALARMS ((KEAN(LINE)),1,LINE)
C
cccc		ANOK=ANOK+1    ! SET IF ANALOG BO
C
cccc	END IF
Ccccccccccc
C
	IF (GOOD(BZAN(LINE))) THEN         	! BURN ZONE temp.
C
		BZTEMP = ANVAL(BZAN(LINE))
	ELSE
C
C	 if bztemp is b.o. stick 2000 in it to force it over to dust
		BOBZ=1
CCCCCC		CALL ALARMS ((BZAN(LINE)),1,LINE)
C
CCCCC		ANOK=ANOK+1    ! SET IF ANALOG BO
C
	END IF
C
C
C
	IF (GOOD(GVAN(LINE))) THEN         ! main gas valve position
C
		VALVP= ANVAL(GVAN(LINE))
	ELSE
		CALL ALARMS ((GVAN(LINE)),1,LINE)
C
	END IF
C
C
C
	IF (GOOD(BZSP(LINE))) THEN         ! BURN ZONE SETPOINT
C
		BZSTPT=ANVAL(BZSP(LINE))
	ELSE
		CALL ALARMS ((BZSP(LINE)),1,LINE)
C
	END IF
C
C
C
cccc	IF (GOOD(PSPAN(LINE))) THEN         ! PELLET TEMP SETPOINT
C
cccccc	patch
cccccc		PELSTPT(LINE)= ANVAL(PSPAN(LINE))
		PELSTPT(LINE)= oncoal(line)
cccc	ELSE
cccc		CALL ALARMS ((PSPAN(LINE)),1,LINE)
C
ccccc	END IF
C
C
C
	IF (GOOD(PELT(LINE))) THEN         ! ACTUAL PELLET TEMP 
C
		PELTEMP(LINE)= ANVAL(PELT(LINE))
	ELSE
		CALL ALARMS ((PELT(LINE)),1,LINE)
C
	END IF
C
C
C
	IF (GOOD(GFAN(LINE))) THEN         ! GAS FLOW MCF
C
		GASFLO= ANVAL(GFAN(LINE))
	ELSE
		CALL ALARMS ((GFAN(LINE)),1,LINE)
C
	END IF
C
C
C
C	    check if this is first time ON CONTROL.
C
C
	IF (STAT(ONGASCX(LINE))) THEN
C
		IF (.NOT. ONGAS(LINE)) THEN  !NOT on control on prev. scan
			ONGAS(LINE)=1
			OBAS(LINE)=VALVP
			OUTPUT(LINE)=VALVP
			DUST(LINE)=0
			GNUM(LINE)=0
			BZOBAS(LINE)=BZSTPT
			BSET(LINE)=BZSTPT
			GFAVG(LINE)=0
C
			DO 88 I=1,TOTNUM
88				GFNUMS(LINE,I)=0.
		END IF
C
	ELSE
		ONGAS(LINE)=0
		DUST(LINE)=0
C
		BZOBAS(LINE)=BZSTPT
		BSET(LINE)=BZSTPT
		GFAVG(LINE)=GASFLO
C
		OUTPUT(LINE)=VALVP
C
C
C		       !OUTPUT GAS VALVE POSITION TO WESTINGHOUSE!
C
		POINT_QUALITY=0
		STATUS=SHC_PUT_POINT_QUALITY (SYSID(17+line),POINT_QUALITY)
c
		PUT_ANALOG_VALUE=OUTPUT(LINE)
C
		STATUS=SHC_PUT_ANALOG_VAL (SYSID(17+LINE),PUT_ANALOG_VALUE)
C
		GO TO 2000	!DO NEXT LINE
C
	END IF
C
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C	AVERAGE GAS FLOW
C
C
	IF ( .NOT. DUST(LINE)) THEN
C
		IF (GNUM(LINE) .EQ. NOP) GO TO 582
C
		GNUM(LINE)=GNUM(LINE)+1
C
		IF (GNUM(LINE) .LE. 1) THEN
			GFAVG(LINE)=GASFLO
			GFNUMS(LINE,1)=GASFLO
			GO TO 140
		END IF
C
582		IF (GNUM(LINE) .GE. 2) THEN
			DO 120 I=GNUM(LINE),2,-1
				GFNUMS(LINE,I)=GFNUMS(LINE,I-1)
120			CONTINUE
C
			GFNUMS(LINE,1)=GASFLO
		END IF
C
C
		GFAVG(LINE)=0.
C
		L=0
C
		DO 121 I=1,GNUM(LINE)
			IF (GFNUMS(LINE,I) .LE. 0) GO TO 121
C
			GFAVG(LINE)=GFAVG(LINE)+GFNUMS(LINE,I)
			L=L+1
C
121		CONTINUE
C
C
		IF (L .LE. 0) GO TO 140
C
		GFAVG(LINE)=GFAVG(LINE)/L
C
C
C
C
	END IF
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C		bobz=1 means burn zone temp. is b.o.
C
140	IF ((BSET(LINE)-BZTEMP) .GE. DUSTLIM(LINE) .OR. BOBZ .EQ. 1) THEN
C
		IF (.NOT. DUST(LINE)) THEN
			DUSTCOUNT(LINE)=DUSTCOUNT(LINE)+1
			IF (DUSTCOUNT(LINE) .GE. 3) THEN
				DUST(LINE)=1
				KOBAS(LINE)=OUTPUT(LINE)
				IF (GFAVG(LINE) .LE. 0) GFAVG(LINE)=GASFLO
				DO 41 I=1,TOTNUM
41					GFNUMS(LINE,I)=0.
			ELSE
				GO TO 2000	!its not dusty yet, but
C						 dont change valve.
			END IF
		END IF
C
	ELSE
C                 no dust!
C
		IF (DUST(LINE)) THEN
		TEMP_INCREASE(LINE)=0
		DUST(LINE)=0
		DUSTCOUNT(LINE)=0
		OBAS(LINE)=OUTPUT(LINE)
		BZOBAS(LINE)=BSET(LINE)
		GNUM(LINE)=0
C
		DO 499 JJ=1,TOTNUM
499			GFNUMS(LINE,JJ)=GFAVG(LINE)
		END IF
C
C
	END IF
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	CHECK THAT BURN ZONE TEMP IS BELOW MAXIMUM (MAXKE)
C
	IF (BZTEMP .GT. MAXKE(LINE)) THEN
C
		BZ_HIGH=.TRUE.
C
	ELSE
C
		BZ_HIGH=.FALSE.
C
	END IF
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C
	IF (DUST(LINE)) THEN
C
C
C
C
C
C
C
		TEMP_INCREASE(LINE)=TEMP_INCREASE(LINE)+1
		TVAL=KETIME(LINE)*60./2
C
		IF (TVAL .GT. 0) THEN
		IF (TEMP_INCREASE(LINE) .LT. TVAL)
	1 	 GFAVG(LINE)=GFAVG(LINE)+(KEUP(LINE)/(KETIME(LINE)*60./2))
		END IF
C
C
CCCCCCCCC	   IF (GFAVG(LINE) .GT. MAXKE(LINE)) GFAVG(LINE)=MAXKE(LINE)
C
C
		ERROR= ((GFAVG(LINE)-GASFLO)*100)/100
C
C
C		  drop valve if BURN ZONE TEMP is above maximum
		IF (BZ_HIGH) THEN
			ERROR=-2.00
		END IF
C
C
		NBAS= ERROR*KRESET(LINE)+KOBAS(LINE)
C
		KOBAS(LINE)=NBAS
		IF (KOBAS(LINE) .LT. MINGV(LINE)) KOBAS(LINE)=MINGV(LINE)
		IF (KOBAS(LINE) .GT. MAXG(LINE)) KOBAS(LINE)=MAXG(LINE)
C
C
		OUTPUT(LINE)= ERROR*KGAIN(LINE)+NBAS
C
C		
C
C
		IF (OUTPUT(LINE) .GT. MAXG(LINE)) OUTPUT(LINE)=MAXG(LINE)
		IF (OUTPUT(LINE) .LT. MINGV(LINE)) OUTPUT(LINE)=MINGV(LINE)
C
C
		POINT_QUALITY=0
		STATUS=SHC_PUT_POINT_QUALITY (SYSID(17+line),POINT_QUALITY)
c
		PUT_ANALOG_VALUE=OUTPUT(LINE)
C
		STATUS=SHC_PUT_ANALOG_VAL (SYSID(17+LINE),PUT_ANALOG_VALUE)
C
C
C
C
C
C

	ELSE
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C		adjust the BURN ZONE SETPOINT based on the diff. between
C		the pellet temp and pellet setpoint.
C
		ERROR=(PELSTPT(LINE)-PELTEMP(LINE))*100/2500
		NBAS=ERROR*PRESET(LINE)+BZOBAS(LINE)
		BZOBAS(LINE)=NBAS
		BSET(LINE)=ERROR*PGAIN(LINE)+NBAS
c
c
c
C		  keep the calculated bz setpoint + or - 25 degrees of
c		  the dialed in westinghouse bz setpoint
c
		IF (BSET(LINE) .LT. (BZSTPT-25.)) THEN
			BSET(LINE)=BZSTPT-25.
			BZOBAS(LINE)=BZSTPT-25.
		ELSE IF (BSET(LINE) .GT. (BZSTPT+25.)) THEN
			BSET(LINE)=BZSTPT+25.
			BZOBAS(LINE)=BZSTPT+25.
		END IF		
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C
C
C
		ERROR= ((BSET(LINE)-BZTEMP)*100)/BZSPAN
C
C
C		 drop valve if BZ temp is above maximum
		IF (BZ_HIGH) THEN
			ERROR=-2.00
		END IF
C
		NBAS= ERROR*RESET(LINE)+OBAS(LINE)
C
		OBAS(LINE)=NBAS
		IF (OBAS(LINE) .LT. MINGV(LINE)) OBAS(LINE)=MINGV(LINE)
		IF (OBAS(LINE) .GT. MAXG(LINE)) OBAS(LINE)=MAXG(LINE)
C
C
		OUTPUT(LINE)= ERROR*GAIN(LINE)+NBAS
C
C		
C
C
		IF (OUTPUT(LINE) .GT. MAXG(LINE)) OUTPUT(LINE)=MAXG(LINE)
		IF (OUTPUT(LINE) .LT. MINGV(LINE)) OUTPUT(LINE)=MINGV(LINE)
C
C
C
		POINT_QUALITY=0
		STATUS=SHC_PUT_POINT_QUALITY (SYSID(17+line),POINT_QUALITY)
c
		PUT_ANALOG_VALUE=OUTPUT(LINE)
		STATUS=SHC_PUT_ANALOG_VAL (SYSID(17+LINE),PUT_ANALOG_VALUE)
C
C
C
C
C
C
C
	END IF
C
C
C	Send calculated BZ setpoint to westinghouse
C
C
	POINT_QUALITY=0
	STATUS=SHC_PUT_POINT_QUALITY (SYSID(25+line),POINT_QUALITY)
c
	PUT_ANALOG_VALUE=BSET(LINE)
	STATUS=SHC_PUT_ANALOG_VAL (SYSID(25+LINE),PUT_ANALOG_VALUE)
C
C
C	Send calculated PELLET TEMPERATURE setpoint to westinghouse
C
C
	POINT_QUALITY=0
	STATUS=SHC_PUT_POINT_QUALITY (SYSID(29+line),POINT_QUALITY)
c
	PUT_ANALOG_VALUE=PELSTPT(LINE)
	STATUS=SHC_PUT_ANALOG_VAL (SYSID(29+LINE),PUT_ANALOG_VALUE)
C
C
C	Send dust mode to westinghouse
C
	put_digital_val=0
	if (dust(line)) put_digital_val=1
c
	POINT_QUALITY=0
	STATUS=SHC_PUT_POINT_QUALITY (SYSID(27+line),POINT_QUALITY)
c
	status=shc_put_digital_val (sysid(27+line),put_digital_val)
C
C
C
2000	CONTINUE
C
C
C
C
C
C
	CALL SYS$HIBER ()
C
 	GO TO 1
C
C                                                      
	END
C
C
C
C
C
	SUBROUTINE ALARMS(JPTNUM,MSGNO,LINE)
C
C
C
C
	INTEGER PUSHTIM(2),ENDTIM(2),ONHEAT,
	1	KLCX(3),KLEMCX(3),F3CX(3),KLUBCX(3),
	2	STAKCX(3),ONCTL(3)/1267,1608,1609/,
	1	KEAN(5),GVAN(3),ON2,CAP
C
	LOGICAL GRATE,KILN
	INTEGER TIMER(2),STATUS,SYS$BINTIM,SYS$SCHDWK,SYS$HIBER,
	1	LIB$SPAWN,GOODPT(50),CXSTS(100),PRINT
C
C
	INTEGER*2 BO,CXOUT(40),GOOD,STAT
C
C 
C
C
	CHARACTER MSG(3)*40,PT*4,FMSG*40
C
C
C
	DATA 	MSG(1)/'SIGNAL BO'/,
	1    	MSG(2)/'HEATUP IS OVER'/	
	1	MSG(3)/'3A FAN STOPPED'/
C
	REAL 	OBAS(2),RESET(2),GAIN(2),DERIV(2),OUTPUT(2),GFAVG(2),
	1	KOBAS(2),KRESET(2),KGAIN(2),KDERIV(2),
	1	MAXG(2),MAXC(2),MAXKE(2),MINGV(2),KMINUTES(2),KEUP(2),
	1	KETIME(2)
C
	INTEGER ONGAS(2),DUST(2),ONCOAL(2),GNUM(2),DUSTCOUNT(2),DUSTLIM(2)
C
C
C
	COMMON /GAS3/ OBAS,RESET,GAIN,DERIV,GFAVG,KOBAS,
	1	KRESET,KGAIN,KDERIV,ONGAS,ONCOAL,DUST,GNUM,
	1	DUSTCOUNT,DUSTLIM,MAXG,MAXC,OUTPUT,MAXKE,MINGV,
	1	KMINUTES,KEUP,KETIME,PELSTPT,PELTEMP,
	1	BZOBAS,PRESET,PGAIN,BSET
C
C                  
C
	IF (ONGAS(LINE) .NE. 0) THEN
C
C		UNIT 1 IS THE OUTPUT PRINTER FOR THE CX AND ANALOG
C                                                    ALARM MESSAGES
C
		OPEN (UNIT=1,FILE='LTA072:',STATUS='UNKNOWN',CARRIAGE
	1	CONTROL='LIST',ERR=1234)
C
	IF ((JPTNUM .LE. 0) .OR. (JPTNUM .GT. 2000)) THEN
		PT='    '     
	ELSE
C
	WRITE (PT,'(I4)')JPTNUM
	END IF
C
C
	WRITE (1,234,err=1234) LINE+5,PT
C
234	FORMAT (' ','LINE ',I1,2X,
	1	'gas CONTROL ERROR MESSAGE'/' ','POINT NO. ',A4,/
	1	' ',' TAKE GAS CONTROL OFF COMPUTER !!')
C
C
	IF (MSGNO .GE. 1) THEN
C
		WRITE (1,604,err=1234) MSG(MSGNO)
C       
	END IF
C
C
1234	CLOSE (1)
C
C
	END IF
C
C
	RETURN
C
C
604	FORMAT (' ',A40)
C
	END
