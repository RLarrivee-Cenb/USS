CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C       CONFIDENTIAL
C       Property of United States Steel Corporation
C       Copyright 2010 United States Steel Corporation
C       All rights reserved.
C******************************************************************************
C               AT3.FOR
C		RJM 09-MAY-1988
C **compile using the /old_f77 switch in the for command**
C FOR /OLD_F77/ALIGN=NONE/WARN=NOALIGN/FLOAT=D_FLOAT/LIS AT3
C******************************************************************************
C Revisions:
C  	7-MAY-1990 accum nos. for doug johnson's "DOUG" program
C	2-JUL-1990 accum nos. for [.ashift]forfile.dat
c   	10-15-04  disabled output of sfil2.lis because of print errors.
c		on filter h2o
C	PR1819 20060208 Print correct pellet spec headings
C	20090326 IM524655 JOH8811 Fix Conc Mn assignment to look at both
C		Step 2 and Step 3 filter cake sio2.  It was only looking
C		at Step 2, but since all of Step 2 is down, it was not
C		assigning a value.
C       20100706 IM322852 SPA6635 add %<300 compression
C	20110322 IM800136 JOH8811 Put %<300 comp into WJBBTX file.
C       20130108 IM1216804 SPA6635 Add 062 Flux pellets specs
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
	EXTERNAL UFO_OPEN
C
	INCLUDE		'($PRCDEF)'
C
	INTEGER*2 MEM/"276/,GROUP/"100/
	INTEGER*4 RPT_DT_INT, SPEC_062_INT
c
	INTEGER SYS$CREPRC
	CHARACTER*10	BTUM/'OREM:BTUMX'/
C
	CHARACTER MON(12)*3/
	1'JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT',
	1'NOV','DEC'/,KY*8,A2*2,FNAM*10,FORA,ASC,KD*8,LAST(2)*6,AINTV/'1'/,
	1 KY6*6,RPT_DT*8
C
	REAL GLS
C
	CHARACTER FILE*6,BPROC*6,VPROC*6,AAM*2,AAY*1,AAD*2,AZ/'0'/,
	1	CODE(3)*6,ADP(368)*6,DATT*6,TD(3)*7/'TXA2:','LTA015:'
	1,'LTA016:'/
	1	,FLD(3)*11,AS,AD*23,
	1 MNTH(12)*3/'JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG',
	1 	'SEP','OCT','NOV','DEC'/,KK2*8
C
	REAL DATA(7,3,31)
C
	INTEGER	FC,BA,BD,CPR,NR,STAT,FLAGS/65/,STATUS,NS,NH,jdat(2),MQ(8),
	1	S4,H4,LS,LH,flag/64/
C
C
	INTEGER*2 TDATA(7),STD(7),STD6(7),FILD(7)
C
C
	DOUBLE PRECISION CT(18),FT(18),SCREEN(14,3,2,5),COMP(2,3,2,5),
	1		 SIL(3,5),FILT2(5,3),BL2,FILT3(5,3),BL3,
	1		 SCR(14,4,5),COMPT(2,4,5),CNT,WAV(10),WAV3(10),
	1		 OIC2(150),OIC3(150),F2A(6,4),F3A(6,4),
	1		 SILA(4,5),QQ,RR,SS,DP(19),DX(8),AC,AC2,AC3,AC4,
	1		 CM,CM2,CM3,CMS(5),CM2S(5),CM3S(5),M4D(12,5,7),
	1		 MC(5),CAB(2,3,5),CABA(2,4,5),FA2,FA3,FLUXG,
	1		 FCA(2,3),FMG(2,3),FAL(2,3),FSI(2,3),PF,PF3,
	1		 WJT(10,3,5),TONS4(3,2,5),SCWT(3,2,5),
	1		 PA(3,5),PC(3,5),PM(3,5),
	1		 DVJ(7,3,2,31),DVJT(7,3,5),DN,DSM,T1,T2,TTS,TA(2),
	1		 ASUM,AN,DPT(5),TS(5),TBS(3,5),XXX,TBSS(3,5),
	1		 XX2,XX3,COMP2(3,3,2,5),ghrs(3,2,5)
	real		 FCMN(4)
C
C
	INTEGER DAT(2),IS,IS2,IS3,DAT2(2),DAT3(2),DIFF(2),DIFF2(2),
	1	RECNO,M4DAT(2),INTV(2),DAT6(2),DD3(2),RPDAT(2),BX(2)
                                                 
C
	CHARACTER FIL(4)*21/'USER_D:[METREP]AMBOIC','USER_D:[METREP]BMHOIC',
	1		    'USER_D:[METREP]AMICON','USER_D:[METREP]BMICON'/,
	1	DATJ*4/'.DAT'/,FNB*40,FNH*40,TIMBUF*23,TIMP*23
	1	,AL(4)/'1','2','3','4'/,DP6*1/'6'/,KK*6
C
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
	STRUCTURE /FOREMAN/
C
		CHARACTER DATE*6        ! KEY 0  DATE (YYMMDD)
C
C
C     	from shift.for
C
		CHARACTER  NAME(3,2)*10	! names by shift
		REAL TONS(5,3)          ! pellet tons
		REAL TIME(5,3)          ! grate hours
		CHARACTER FA(5,3)	! F=FLUX, A=ACID
		REAL MBTU(5,3)          ! btus/ton
		REAL BENT(5,3)          ! bent. lbs/ton
C
C
C	from met_p:attfc.for
C
		REAL BT(5,3)   		! before tumble +1/4
		REAL AT(5,3)    	! after tumble +1/4
		REAL COMP(5,3)          ! compression
		REAL PBA(5,3)           ! pellet b/a
		REAL PSIL(5,3)		! pellet sio2
		REAL FCR(2,3)           ! filter cake ratio
C
	END STRUCTURE
C
	RECORD /FOREMAN/ FOR,forz
C
C
	REAL MINCOMP(2)/350,15/
C
c
c
c
c
	STRUCTURE /SHIFT/
C
		CHARACTER 	DS*7		! 1-6=YYMMDD  7=SHIFT   (KEY 0)
		INTEGER		INPTIME(2)	! INPUT TIME
		CHARACTER 	FOREMAN*14
		CHARACTER 	TL*14
		CHARACTER 	OPER*14
C
		REAL		TPH(18)
		REAL		LGRIND(18)
		REAL 		OPHRS(18)
C
		INTEGER		INDEX(2,40)
		CHARACTER	DELAYS(40)*64
C
		REAL		GRINDS(3)
		REAL		CNOLA(3)
		REAL		SIL(3)
		REAL		TARG(3)
		REAL		RECV(3)
		REAL		BINS(3)
		REAL		RAW(2)
		REAL		FLOC(3)
		INTEGER		DOWN(18)	! 1=DOWN
		REAL		FLSIL
		REAL		FLFE
		REAL		AMINE
		INTEGER		BANKS(4)	! 1=DOWN
		REAL		FLREC
		REAL		CT
		REAL		FT
		INTEGER		LR		! LINES RUNNING
		REAL		AL		! AVERAGE LINES
		INTEGER		FPLUGS
		INTEGER		DIKE
		INTEGER		PIT
		CHARACTER	RES*5
		INTEGER		FLXBINLVL
		CHARACTER*4	FROTHSTAT
		INTEGER 	FLUXSTAT
		INTEGER		FLXTM(2)
		CHARACTER*3	AGBINS(5)
		INTEGER		AGTANKS(6)
		LOGICAL		SPC2,SPC3
C
		CHARACTER	MFLOSS*80
		CHARACTER	HKEEP(3)*80
		LOGICAL		SAFE
		CHARACTER	SAFEMSG*160
		CHARACTER	UTIL(3)*80
		CHARACTER	CTPROB(3)*80
C
		CHARACTER	MDOWN(168)*40
C
		INTEGER  	SST(2,2,16,20)         ! STOP TIME, START TIME
c
		REAL	       	REALTIME	 !time since beginning of shift
		LOGICAL		SPC2S,SPC3S	!in control for shift
C
		REAL		RRATIO		!RECOVERY RATIO
		REAL		LFT(7)		!FINE TAILS BY SECTION
		REAL		LCT(18)		!COARSE TAILS BY LINE
		CHARACTER	MFLOSS2*80   !added to mag loss by rjs 14mar94
		INTEGER		RGONOFF		!1-MILL ON 0-MILL OFF
		REAL		RGPOP		!%OP TIME RGRND MILL 
		REAL		FTC(8)	     !%froth to cyc.- max 8entry/shift
		REAL		FTCH(8)	     !hours for each entry
		REAL		LIMESTONE	!SHIFT LIMESTONE TONS
		REAL		LIMEGRIND	!LAST -200 GRIND FOR LIMESTONE
		REAL		LIMETPH		!LIMESTONE TPH
		CHARACTER       HIGHF(9)*81     !HI F.T. PROBLEMS BY SECTION
		CHARACTER       HIGHC(18)*81    !HI C.T. PROBLEMS BY LINE
		CHARACTER       LOWT(18)*81     !LOW TPH BY LINE
		REAL		TONS		!TOTAL RMF TONS 
		REAL		CONC		!TOTAL CONC. TONS
		REAL		CCP             !column conc % (1404)
 	END STRUCTURE
C
	RECORD /SHIFT/ DATQ
C
	CHARACTER A3X
	REAL BL2X(4),BL3X(4)
c
	DOUBLE PRECISION SD(4,5),SX(3,7)
C
C	  this structure is in MMC.DAT, the key is a descending string
	STRUCTURE /XX/
		CHARACTER DATE*7/'       '/	!YYMMDDS    key 0
		REAL	  FFDATA(4)	! AL2O3,CAO,MGO,MNO
		REAL	  FCDATA(7)	!SIL,AL,CAL,MG,MN,-270
		REAL	  BENT(5)	!BENTONITE LBS/TON BY LINE
		REAL	  CTONS         !CRUSHER SCANNER TONS
		REAL 	  CSIL          !MINE IND. SILICA
		REAL	  CMF           !MINE IND. MAG FE
		REAL	  CWTR          !MINE PREDIC. RECOVERY
		REAL	  CA            !MINE "A" FACTOR
		REAL	  CT            !AVG. COARSE TAILS
		REAL	  FT            !AVG. FINE TAILS
		REAL 	  FR		!FROTH REGRIND % OP TIME
		REAL	  AM		!AMINE LBS/TON
	END STRUCTURE
C
	RECORD /XX/ FFD
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C
	INCLUDE 'MET_P:MATERIAL.FOR'	! flux or acid check
	for=forz
	CALL SYS$BINTIM (AINTV,INTV) !convert 24 hr interval to binary
C
	KK='      '
C
	OPEN (UNIT=29,FILE='MET_P:ATTINFO.DAT',FORM='UNFORMATTED',
	1	STATUS='UNKNOWN')
	READ (29,ERR=3722) IFIL,IREC,KK
	JFIL=0
C
	IF (KK(1:1) .EQ. ' ') GO TO 3722
	IF (KK(1:2) .LT. '60') THEN
		KK2='20'//KK
	ELSE
		KK2='19'//KK
	END IF
3722	REWIND (29)
C
	WRITE (29) JFIL,JFIL
	CLOSE (29)
C
cccccccccccccccccccccccccccccccccc
c
C
	OPEN (88,FILE='MET_SCREEN:SCREEN.DAT',
	1	ACCESS='KEYED',STATUS='old',shared)

C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
	IF ((IFIL .EQ. 0).AND.(IREC.EQ.0).AND.(.NOT.(KK(1:1).EQ.' '))) THEN
C
	READ (88,KEY=KK2,IOSTAT=MMM) KD,DAT,IS,IH,SCREEN,COMP,
	1			    	    CAB,SIL,FILT2,
	1			    FILT3,BL2,BL3,FLUXG,FCA,FMG,FAL,FSI,   
	1			    PA,PC,PM,S4,H4,SCWT,TONS4,GHRS,COMP2
C
	LS=IS
	LH=IH
	NS=IS
	NH=IH
	GO TO 1177
C
	END IF
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C	 bring in LAB7.DAT to get date,shift, half in ascii of last entry
c
	OPEN (UNIT=10,FILE='USER_D:[METREP.LAB45]LAB7.DAT',STATUS='OLD',
	1ACCESS='DIRECT',FORM='FORMATTED',SHARED,READONLY)
C
	READ(10,55,REC=1)KY6,LS,LH
C
	ky='19'//ky6
	if (ky6(1:2) .lt. '66') ky='20'//ky6
C
	CLOSE (10)
c
C                                                                  
	READ (88,KEY=KY,IOSTAT=MMM) KD,DAT,IS,IH,SCREEN,COMP,
	1		 	    CAB,SIL,FILT2,
	1			    FILT3,BL2,BL3,FLUXG,FCA,FMG,FAL,FSI,   
	1			    PA,PC,PM,S4,H4,SCWT,TONS4,GHRS,COMP2
c
C
cccccccccccccccccccccccccccccccccc
C
1177	if (irec .eq. 2) then
c
c		get the second newest file
c
C
		AD(7:11)=KD(1:4)
		READ (KD(5:6),'(I2)')MV
		AD(3:6)='-'//MNTH(MV)
		AD(1:2)=KD(7:8)
		ad(12:23)='            '
C
		CALL SYS$BINTIM (AD,BX)
		CALL LIB$SUB_TIMES (BX,INTV,BX)
		CALL SYS$ASCTIM (,AD,BX,)
		IF (AD(1:1) .EQ. ' ') AD(1:1)='0'
C
		DO 91 I=1,12           
			IF (MNTH(I) .EQ. AD(4:6)) GO TO 4191
91		CONTINUE
C
C
		STOP ' MONTH ERROR'
C
4191		WRITE (KY(5:6),'(I2)') I
		IF (KY(5:5) .EQ. ' ') KY(5:5)='0'
C
		
		KY(1:4)=AD(08:11)
		KY(7:8)=AD(1:2)

	READ (88,KEY=KY,IOSTAT=MMM) KD,DAT,IS,IH,SCREEN,COMP,
	1		 	    CAB,SIL,FILT2,
	1			    FILT3,BL2,BL3,FLUXG,FCA,FMG,FAL,FSI,   
	1			    PA,PC,PM,S4,H4,SCWT,TONS4,GHRS,COMP2       
c
C
C
	IF ((IFIL .EQ. 0) .AND. (IREC .EQ. 2)) THEN
C
		RECNO=2
C
		NH=2	!FOR WJB                        
C
		GO TO 811
C
	END IF
c
C
	IF ((IFIL .EQ. 1) .AND. (IREC .EQ. 2)) STOP ' IFIL=1, IREC=2'
C
	end if
C
ccccccccccccccccccccccccccccccccccccccccccccccc
c
c
c
	KY=KD
C
C
C
C
C
	RECNO=1
C
C
		NH=LH
		NS=LS
C
c
c
c
cccccccccccccccccccccccc    is it end of day?  ccccccccccccccccccc
c
	IF ((IFIL .EQ. 1) .AND. (IREC .EQ. 1)) THEN
C
C	 bring in LAB7.DAT to get date,shift, half in ascii of last entry
c
	OPEN (UNIT=10,FILE='USER_D:[METREP.LAB45]LAB7.DAT',STATUS='OLD',
	1ACCESS='DIRECT',FORM='FORMATTED',SHARED,READONLY)
C
	READ(10,55,REC=1)KY6,LS,LH
C
55	FORMAT (A6,I1,I1)
C
	ky='19'//ky6
	if (ky6(1:2) .lt. '66') ky='20'//ky6
c
	CLOSE (10)
c
C
	READ (88,KEY=KY,IOSTAT=MMM) KD,DAT,IS,IH,SCREEN,COMP,
	1		 	    CAB,SIL,FILT2,
	1			    FILT3,BL2,BL3,FLUXG,FCA,FMG,FAL,FSI,   
	1			    PA,PC,PM,S4,H4,SCWT,TONS4,GHRS,COMP2
c
C
	END IF
C	
c
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
c
	if ((is .eq. 3) .and. (ih .eq. 2)) then
C
		RECNO=2
		NH=2	!FOR WJB
		NS=3
C
	END IF
C                                                     
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C	GET THE COMPRESSION STANDARD DEVIATIONS FOR ALL LINES THRU
C	PRESENT SHIFT AND HALF AND STORE THEM IN SD(3,7)
C
	CALL COMP_STD_DEV (KD(3:8),LS,LH,Sx)
c
	do 7761 j=3,7
	do 7761 i=1,3
		sd(i,j-2)=sx(i,j)
7761	continue
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
1728	IF ((IFIL .EQ. 1) .AND. (NH .EQ. 2)) THEN
C
C	  open doug johnson file, 7 nos. a shift for 31 days
C
	OPEN (UNIT=22,FILE='MET_P:DVJ.DAT',FORM='UNFORMATTED',
	1	ACCESS='DIRECT',RECL=3000,STATUS='UNKNOWN',
	1	ORGANIZATION='SEQUENTIAL')
CCC	1	SHARED,USEROPEN=UFO_OPEN)
C
	read (22,REC=1) jdat	!date of last entry
	READ (22,REC=2) DVJ
C
	IF ((JDAT(1) .NE. DAT(1)) .OR. (JDAT(2) .NE. DAT(2))) THEN
C
		JDAT(1)=DAT(1)
		JDAT(2)=DAT(2)
C
		WRITE (22,REC=1) JDAT
C
C
C
C		  roll data down one day
C
		DO 161 I=2,31
		DO 161 J=1,3
		DO 161 K=1,2
		DO 161 L=1,7
C
161			DVJ(L,J,K,I-1)=DVJ(L,J,K,I)
C
C
C		  zero out latest day
C
		DO 722 J=1,3
		DO 722 K=1,2
		DO 722 L=1,7
722			DVJ(L,J,K,31)=0.
	END IF
C
C
	END IF
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
811	CLOSE (88)
	CLOSE (87)
C
C
C	average screen fractions for all 3 shifts
C
	CALL SYS$ASCTIM(,TIMBUF,DAT,)	!convert file date to ascii
C
	CALL SYS$ASCTIM(,TIMP,,)	!put present time in TIMP
C
C
	IF ((IFIL .EQ. 1) .AND. (NH .EQ. 2)) THEN
CCCCCCCCCCCCCCC
C
C		open agglom. foreman file on 2nd half of each shift
C
	LV=0
C
9879	OPEN   (UNIT=50,FILE='USER_D:[METREP.ASHIFT]FORFILE.DAT',
	1	STATUS='UNKNOWN',ORGANIZATION='INDEXED',ACCESS='KEYED',
	1	FORM='UNFORMATTED',RECL=256,KEY=(1:6:CHARACTER),
	1	ERR=5151,shared)
C
	GO TO 5152
C
CCCCCCCCCCCCCCC
C
C
5151	LV=LV+1
	IF (LV .GT. 300) THEN
		WRITE (6,*) ' FORFIL.DAT IS LOCKED, CALL RJM @ 7490'
		CALL LIB$WAIT(5.)
		GO TO 812
	END IF
C
	CALL LIB$WAIT (1.)
	GO TO 9879
C
C
CCCCCCCCCCCCCCC
5152		DO 3737 MM=1,12
			IF (MON(MM) .EQ. TIMBUF(4:6)) GO TO 1108
3737		CONTINUE
		GO TO 812
C
C
1108		WRITE (A2, '(I2)')MM
		IF (MM .LT. 10) A2='0'//A2(2:2)
		IF (TIMBUF(1:1) .EQ. ' ')TIMBUF(1:1)='0'
C
		KY=TIMBUF(10:11)//A2//TIMBUF(1:2)
C
		itime=0
2744		READ (50,KEY=KY(1:6),IOSTAT=LLX) FOR
C
		if (llx .eq. 52) then
			call lib$wait (1.)
			itime=itime+1
			if (itime .gt. 30) go to 7272
			go to 2744
		end if
C
7272		CONTINUE
C
	END IF
C
CCCCCCCCCCCCCCC
C	  sum up pellet tons and hours
C
812	DO 449 LN=1,5
	DO 449 ISH=1,LS
		LL=2
		IF (ISH .EQ. IS)LL=LH
	DO 449 IIH=1,LL
449		DPT(LN)=DPT(LN)+TONS4(ISH,IIH,LN)
C
C
	DO 1800 LN=1,5
C
	DO 1800 ISH=1,LS
C
	AC=0
	AC2=0
	AC3=0
	AC4=0
C
	DO 1800 IT=1,8
C
	IF (IT .EQ. 8) GO TO 911
C
	ITX=IT+7
	AC=AC+SCREEN(IT,ISH,1,LN)
	AC2=AC2+SCREEN(ITX,ISH,1,LN)
	AC3=AC3+SCREEN(IT,ISH,2,LN)
	AC4=AC4+SCREEN(ITX,ISH,2,LN)
C
C
C
1799	CONTINUE
C
1800	CONTINUE
C
C
C
	GO TO 2424
C
C
C
911	DO 912 ITA=1,7
C
	ITB=ITA+7
	IF (AC .EQ. 0) THEN
	SCREEN(ITA,ISH,1,LN)=0
	ELSE		
	SCREEN(ITA,ISH,1,LN)=100.*SCREEN(ITA,ISH,1,LN)/AC
	END IF
C
	IF (AC2 .EQ. 0) THEN		
	SCREEN(ITB,ISH,1,LN)=0
	ELSE
	SCREEN(ITB,ISH,1,LN)=100.*SCREEN(ITB,ISH,1,LN)/AC2
	END IF
C
	IF (AC3 .EQ. 0) THEN
	SCREEN(ITA,ISH,2,LN)=0
	ELSE
	SCREEN(ITA,ISH,2,LN)=100.*SCREEN(ITA,ISH,2,LN)/AC3
	END IF
C
	IF (AC4 .EQ. 0) THEN
	SCREEN(ITB,ISH,2,LN)=0
	ELSE
	SCREEN(ITB,ISH,2,LN)=100.*SCREEN(ITB,ISH,2,LN)/AC4
	END IF
C
912	CONTINUE 
C
	GO TO 1799
C
C
C
C
2424	DO 100 LN=1,5
C
C
	TS(LN)=DPT(LN)
C
C
	DO 100 ISH=1,LS
C
C
C	 if there is no screen fraction for one or both of the halves, remove
C	the tons from the total.
C
	IF (SCREEN(3,ISH,1,LN) .LE. 0) THEN
		TS(LN)=TS(LN)-TONS4(ISH,1,LN)
	ELSE
		TBS(ISH,LN)=TONS4(ISH,1,LN)
	END IF
C
C
C
	IF (SCREEN(3,ISH,2,LN) .LE. 0) THEN
		IF (ISH .EQ. IS .AND. IH .LT. 2) GO TO 553 
		TS(LN)=TS(LN)-TONS4(ISH,2,LN)
	ELSE
		IF (ISH .EQ. IS .AND. IH .LT. 2) GO TO 553 
		TBS(ISH,LN)=TBS(ISH,LN)+TONS4(ISH,2,LN)

	END IF
C
C
C
553	DO 100 IT=1,14
C
C
	IF (TONS4(ISH,1,LN)+TONS4(ISH,2,LN) .LE. 0) GO TO 100
C
		IF (ISH .EQ. LS .AND. LH .LT. 2)THEN 
C
		SCR(IT,ISH,LN)=SCREEN(IT,ISH,1,LN)*TONS4(ISH,1,LN)
C
		ELSE
C
		SCR(IT,ISH,LN)=SCREEN(IT,ISH,1,LN)*TONS4(ISH,1,LN)+
	1			SCREEN(IT,ISH,2,LN)*TONS4(ISH,2,LN)
C
		END IF
C
100	CONTINUE
C                                    
C
	DO 120 LN=1,5
	DO 120 IT=1,14
C
	IF (TS(LN) .LE. 0) GO TO 120
C
	SCR(IT,4,LN)=(SCR(IT,1,LN)+SCR(IT,2,LN)+SCR(IT,3,LN))/TS(LN)
C
120	CONTINUE
C
	DO 3100 LN=1,5
	DO 3100 ISH=1,LS
C
	DO 3100 IT=1,14
C
C
	IF (TBS(ISH,LN) .LE. 0) GO TO 3100
C
	SCR(IT,ISH,LN)=SCR(IT,ISH,LN)/TBS(ISH,LN)
C
C
3100	CONTINUE
C
	do 6671 LN=1,5
6671		TBSS(LS,LN)=TBS(LS,LN)
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C		get average compressions for all 3 shifts
C
C
	DO 200 LN=1,5
C
		TS(LN)=DPT(LN)
C
	DO 200 ISH=1,LS
C
		TBS(ISH,LN)=0
C
C	 if there is no compressions for one or both of the halves, remove
C	the tons from the total.
C
	IF (COMP2(1,ISH,1,LN) .gt. 200) THEN
		TBS(ISH,LN)=TONS4(ISH,1,LN)
	END IF
C
C
	IF (COMP2(1,ISH,2,LN) .gt. 200) THEN
		TBS(ISH,LN)=TBS(ISH,LN)+TONS4(ISH,2,LN)
	END IF
C
C
C
C
	DO 200 IT=1,2
C
C
	IF (TONS4(ISH,1,LN)+TONS4(ISH,2,LN) .LE. 0) GO TO 200
C
	COMPT(IT,ISH,LN)=COMP2(IT,ISH,1,LN)*TONS4(ISH,1,LN)+
	1		COMP2(IT,ISH,2,LN)*TONS4(ISH,2,LN)
C
C
200	CONTINUE     
C
C
	DO 220 LN=1,5
	DO 220 IT=1,2
C
	IF ((TBS(1,LN)+TBS(2,LN)+TBS(3,LN)) .LE. 0) GO TO 220
C
	COMPT(IT,4,LN)=(COMPT(IT,1,LN)+COMPT(IT,2,LN)+COMPT(IT,3,LN))/
	1(TBS(1,LN)+TBS(2,LN)+TBS(3,LN))
C
220	CONTINUE
C
C
	DO 7200 LN=1,5
C
	DO 7200 ISH=1,LS
C
	DO 7200 IT=1,2
C
C
	IF (Tbs(ish,ln) .LE. 0) GO TO 7200
C
	COMPT(IT,ISH,LN)=COMPT(IT,ISH,LN)/TBS(ISH,LN)
C
C
7200	CONTINUE     
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C	average sio2
C
C
	DO 300 LN=1,5
C
	TS(LN)=DPT(LN)
C
cccccccc	IF (TONS4(1,1,LN)+TONS4(1,2,LN) .LE. 0) GO TO 300
C
	SILA(1,LN)=SIL(1,LN)*(TONS4(1,1,LN)+TONS4(1,2,LN))
	SILA(2,LN)=SIL(2,LN)*(TONS4(2,1,LN)+TONS4(2,2,LN))
	SILA(3,LN)=SIL(3,LN)*(TONS4(3,1,LN)+TONS4(3,2,LN))
C
	IF (SIL(1,LN) .LE. 0) TS(LN)=TS(LN)-(TONS4(1,1,LN)+TONS4(1,2,LN))
	IF (IS .LT. 2) GO TO  226
	IF (SIL(2,LN) .LE. 0) TS(LN)=TS(LN)-(TONS4(2,1,LN)+TONS4(2,2,LN))
	IF (IS .LT. 3) GO TO 226
	IF (SIL(3,LN) .LE. 0) TS(LN)=TS(LN)-(TONS4(3,1,LN)+TONS4(3,2,LN))
C
226	IF (TS(LN) .LE. 0) GO TO 300
C
	SILA(4,LN)=(SILA(1,LN)+SILA(2,LN)+SILA(3,LN))/TS(LN)
C
C
300	CONTINUE
C
	DO 3005 LN=1,5
	DO 3005 ISH=1,LS
C
	IF (TONS4(ISH,1,LN)+TONS4(ISH,2,LN) .LE. 0) GO TO 3005
C
	SILA(ISH,LN)=SILA(ISH,LN)/(TONS4(ISH,1,LN)+TONS4(ISH,2,LN))
C
C
C
3005	CONTINUE
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	CAO/MGO & B/A
C
	DO 991 J=1,5
		TS(J)=DPT(J)
	DO 991 I=1,LS
	IF (CAB(1,I,J) .LE. 0) TS(J)=TS(J)-(TONS4(I,1,J)+TONS4(I,2,J))
	if (cab(1,i,j) .gt. 0) then
	CABA(1,I,J)=CAB(1,I,J)*(TONS4(I,1,J)+TONS4(I,2,J))
	CABA(2,I,J)=CAB(2,I,J)*(TONS4(I,1,J)+TONS4(I,2,J))
	end if
991	continue
C
	DO 820 LN=1,5
	DO 820 IT=1,2
C
	IF (TS(LN) .LE. 0) GO TO 820
C
	CABA(IT,4,LN)=(CABA(IT,1,LN)+CABA(IT,2,LN)+CABA(IT,3,LN))/TS(LN)
C
820	CONTINUE
C
	DO 9911 I=1,LS
	DO 9911 J=1,5
	IF (TONS4(I,1,J)+TONS4(I,2,J) .LE. 0) GO TO 9911
	CABA(1,I,J)=CABA(1,I,J)/(TONS4(I,1,J)+TONS4(I,2,J))
	CABA(2,I,J)=CABA(2,I,J)/(TONS4(I,1,J)+TONS4(I,2,J))
9911	CONTINUE
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C		convert filter ca,mg,al,si to ca/mg and b/a
C
	DO 388 MM=1,3
		IF (FMG(1,MM) .LE. 0) GO TO 508
		FILT2(4,MM)=FCA(1,MM)/FMG(1,MM)
508		IF ((FAL(1,MM)+FILT2(1,MM)) .LE. 0) GO TO 509
		FILT2(5,MM)=(FCA(1,MM)+FMG(1,MM))/(FAL(1,MM)+FILT2(1,MM))
509		IF (FMG(2,MM) .LE. 0) GO TO 510
		FILT3(4,MM)=FCA(2,MM)/FMG(2,MM)
510		IF ((FAL(2,MM)+FILT3(1,MM)) .LE. 0) GO TO 388
		FILT3(5,MM)=(FCA(2,MM)+FMG(2,MM))/(FAL(2,MM)+FILT3(1,MM))
388	CONTINUE
C
C
C	filter data
C
	DO 4040	LQ=1,3
C
	IF ((FCA(1,LQ).LE.0) .OR. (FMG(1,LQ).LE.0)) GO TO 4039
		F2A(6,LQ)=((FCA(1,LQ)+FMG(1,LQ))-.6)/.5377
		F2A(6,LQ)=F2A(6,LQ)/(100.-F2A(6,LQ))
4039	IF ((FCA(2,LQ).LE.0) .OR. (FMG(2,LQ).LE.0)) GO TO 4040
		F3A(6,LQ)=((FCA(2,LQ)+FMG(2,LQ))-.6)/.5377
		F3A(6,LQ)=F3A(6,LQ)/(100.-F3A(6,LQ))
4040	CONTINUE
C
	DO 400 IT=1,6
C
	IF (IT .EQ. 6) GO TO 19
	F2A(IT,1)=FILT2(IT,1)
	F2A(IT,2)=FILT2(IT,2)
	F2A(IT,3)=FILT2(IT,3)
	F3A(IT,1)=FILT3(IT,1)
	F3A(IT,2)=FILT3(IT,2)
	F3A(IT,3)=FILT3(IT,3)
C
19	CNT=0.
	IF (F2A(IT,1) .NE. 0) CNT=CNT+1.
	IF (F2A(IT,2) .NE. 0) CNT=CNT+1.
	IF (F2A(IT,3) .NE. 0) CNT=CNT+1.
C
	IF (CNT .EQ. 0) GO TO 501
C
	F2A(IT,4)=(F2A(IT,1)+F2A(IT,2)+F2A(IT,3))/CNT
C
C
501	CNT=0.
	IF (F3A(IT,1) .NE. 0) CNT=CNT+1.
	IF (F3A(IT,2) .NE. 0) CNT=CNT+1.
	IF (F3A(IT,3) .NE. 0) CNT=CNT+1.
C
	IF (CNT .EQ. 0) GO TO 400
C
	F3A(IT,4)=(F3A(IT,1)+F3A(IT,2)+F3A(IT,3))/CNT
C
C
400	CONTINUE
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C	OUTPUT DEVICE
C
	OPEN (UNIT=61,FILE='MET_P:SFIL2.LIS',STATUS='UNKNOWN',
	1	SHARED,USEROPEN=UFO_OPEN)
C
CCCCCC	OPEN (UNIT=62,FILE='VAXLINK:ATTDAT.LNK',ACCESS='SEQUENTIAL',RECL=114
CCCCCC	1      ,RECORDTYPE='FIXED',STATUS='UNKNOWN')
C
	GO TO 6722
C
C
6722	JDE=1
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C  PATCH PATCH PATCH PATCH PATCH
CCCCCC	IF (IFIL .EQ. 1) JDE=2
	IF (IFIL .EQ. 1) JDE=1
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
	DO 797 IDEV=1,JDE    
C
	IF (IDEV .GT. 1) THEN
C
	IDX=IDEV
C
	IF (RECNO .EQ. 2) IDX=3	!send output to txa3: if it's end of day
C    patch patch
c	OPEN (UNIT=6,FILE=TD(IDX),STATUS='UNKNOWN',
c	1	CARRIAGECONTROL='FORTRAN',ERR=745)
	OPEN (UNIT=6,FILE='met_P:dumpout',STATUS='UNKNOWN',
	1	CARRIAGECONTROL='FORTRAN',ERR=745)
C
	GO TO 259
C
C		open alternate device if one is failed
c
cc744	IF (IDX .EQ. 2) THEN
cc		IDX=3
cc	ELSE
cc		IDX=2
ccc	END IF
C
ccc	OPEN (UNIT=6,FILE=TD(IDX),STATUS='UNKNOWN',
ccc	1	CARRIAGECONTROL='FORTRAN',ERR=745)
C
cccc	GO TO 259
C
745	WRITE (6,*) ' the step 2 agglom agldat printer is bad, call 1284'
	call lib$wait (3.)
	go to 6014
C
	END IF
C
259	CALL LIB$SPAWN('SET TERM/WIDTH=132',,,flag)
C
3401	JJCNT=0
C
	IF (RECNO .EQ. 2) THEN
C                                              
		I1=LS
		I2=LH
C
	ELSE
C
		I1=LS
		I2=LH
C
	END IF
C
C
401	WRITE (6,2001,IOSTAT=MMV,ERR=745) TIMP(1:17),TIMBUF(1:11),I1,I2
2001	FORMAT ('1',33X,'AGGLOMERATOR PELLET 
	1AND FILTER CAKE DATA REPORT',5X,'RUN ON: ',
	1A17//' ',45X,'REPORT FOR: ',A11,17X,
	1'THRU: SHIFT ',I1,'  HALF ',I1)
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2001) TIMP(1:17),TIMBUF(1:11),I1,I2
	END IF
C
	IF (TIMBUF(1:1) .EQ. ' ')TIMBUF(1:1)='0'
C
	RPT_DT(1:4)=TIMBUF(8:11)
	RPT_DT(7:8)=TIMBUF(1:2)
        
	SELECT CASE (TIMBUF(4:6))
	  CASE ('JAN')
		RPT_DT(5:6)='01'
	  CASE ('FEB')
		RPT_DT(5:6)='02'
	  CASE ('MAR')
		RPT_DT(5:6)='03'
	  CASE ('APR')
		RPT_DT(5:6)='04'
	  CASE ('MAY')	
		RPT_DT(5:6)='05'
	  CASE ('JUN')
		RPT_DT(5:6)='06'
	  CASE ('JUL')
		RPT_DT(5:6)='07'
	  CASE ('AUG')
		RPT_DT(5:6)='08'
	  CASE ('SEP')
		RPT_DT(5:6)='09'
	  CASE ('OCT')
		RPT_DT(5:6)='10'
	  CASE ('NOV')
		RPT_DT(5:6)='11'
	  CASE ('DEC')
		RPT_DT(5:6)='12'          
	END SELECT
	DO 3000 LIN=1,5               
C
C
C
C
	IF (LIN .EQ. 1) THEN
C
191	FORMAT (' ')
C
	WRITE (6,191,IOSTAT=MMV)
	WRITE (6,191,IOSTAT=MMV)
	WRITE (6,191,IOSTAT=MMV)
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,191)
	WRITE (61,191)
	WRITE (61,191)
	END IF
C
	WRITE (6,2002,IOSTAT=MMV)
2002	FORMAT ('    **      BEFORE TUMBLE     ** ***      AFTER TUMBLE
	1              **   CUMULATIVE +1/4   COMPRESSION
	1            * PELLET *')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2002)
	END IF
C
	IF (FTNFFB) GO TO 887
C
86	WRITE (6,191,IOSTAT=MMV)
	WRITE (6,2203,IOSTAT=MMV)
2203	FORMAT (' *** SPECIFICATIONS ***    054 GRADE ACID PELLETS')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2203)
	END IF
C
	WRITE (6,2204,IOSTAT=MMV)
2204	FORMAT (' MX/MN  14.9',56X,' 3.0   97.5  96.0',2X,' 450     9.3'
	1,22X,'>5.05 <5.75')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2204)
	END IF
C
	WRITE (6,2205,IOSTAT=MMV)
2205	FORMAT (' MEAN    7.8',57X,'2.2   98.5  97.0',3X,'500     4.9',
	1	23X,'5.40')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2205)
	END IF
C
	WRITE (6,2206,IOSTAT=MMV)
2206	FORMAT ('     +    +    +    +    +    -    +    +    +    +
	1   +    -')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2206)
	END IF
C
	WRITE (6,2007,IOSTAT=MMV)
C2207	FORMAT ('   9/16  1/2  3/8  1/4  28M  28M 9/16  1/2  3/8  1/4
C	1  28M  28M   B.T.  A.T.  Q IN   AVG  <200                SIO2')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2007)
	END IF
C
C
	IF (LIN .EQ. 4) GO TO 712
C                
C
	END IF
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
	IF (LIN .EQ. 4) THEN
C
C
	IF (FTNFFB .AND. FTNFFH) GO TO 712
	IF ((.NOT. FTNFFB) .AND. (.NOT. FTNFFH)) GO TO 712
C
	IF (.NOT. FTNFFH) GO TO 86
C
C
C
	WRITE (6,191,IOSTAT=MMV)
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,191)
	END IF
C
	WRITE (6,2002,IOSTAT=MMV)
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2002)
	END IF
C
887	WRITE (6,191,IOSTAT=MMV)

2003	FORMAT (' *** SPECIFICATIONS ***    060 GRADE FLUX PELLETS')
2013	FORMAT (' *** SPECIFICATIONS ***    062 GRADE FLUX PELLETS')
C
	IF (IDEV .EQ. 1) THEN
	  IF (RPT_DT .LT. '20130115') THEN
	    WRITE (61,2003)
	    WRITE (61,2004)
	    WRITE (61,2005)
	    WRITE (61,2006)
	    WRITE (61,2007)
          ELSE
            WRITE (61,2013)
	    WRITE (61,2014)
       	    WRITE (61,2015)
	    WRITE (61,2006)
	    WRITE (61,2007)
	  END IF
	END IF
C
C	IF (RPT_DT_INT.LT.SPEC_062_INT) THEN
	IF (RPT_DT .LT. '20130115') THEN
	   WRITE (6,2003,IOSTAT=MMV)
	   WRITE (6,2004,IOSTAT=MMV)
	   WRITE (6,2005,IOSTAT=MMV)
	   WRITE (6,2006,IOSTAT=MMV)
	   WRITE (6,2007,IOSTAT=MMV)
	ELSE
	   WRITE (6,2013,IOSTAT=MMV)
	   WRITE (6,2014,IOSTAT=MMV)
	   WRITE (6,2015,IOSTAT=MMV)
	   WRITE (6,2006,IOSTAT=MMV)
	   WRITE (6,2007,IOSTAT=MMV)
	END IF
2004	FORMAT (' MX/MIN 17.0',56X,' 4.0   97.0  95.0',2X,' 400   10.3'
	1,13X,'1.16/.92',' 3.98/4.52')
2014	FORMAT (' MX/MIN 17.0',56X,' 4.0   97.0  95.0',2X,' 400   10.3'
	1,13X,'1.08/.84',' 4.87/4.33')
C
2005	FORMAT (' MEAN    8.5',57X,'2.6   98.0  96.0',3X,'445    4.9',
	1	15X,'1.04',3X,'4.25')
2015	FORMAT (' MEAN    8.5',57X,'2.6   98.0  96.0',3X,'445    4.9',
	1	15X,'0.96',3X,'4.60')
C

2006	FORMAT ('     +    +    +    +    +    +    -    +    +    +
	1    +    +    +    -')
C

2007	FORMAT (' ',93X,'       COMP.  CAO/'/' ',
	1'  9/16  1/2 7/16  3/8  1/4  28M  28M 9/16  1/2 7/16  3/8  1/4
	1  28M  28M   B.T.  A.T.   AVG   <200
	1   ST DV  MGO    B/A   SIO2')
C
	END IF	!LIN.EQ.4
C
712	WRITE (6,2008,IOSTAT=MMV)LIN+2
2008	FORMAT ('0LINE ',I1)
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2008)LIN+2
	END IF
C
	DO 3000 ISH=1,4
C
C
	QQ=
	1	((100.-SCR(6,ISH,LIN)-SCR(7,ISH,LIN))*
	1	(100.-SCR(13,ISH,LIN)-SCR(14,ISH,LIN)))/100.
C
	RR=	100.-SCR(6,ISH,LIN)-SCR(7,ISH,LIN)
C
	SS=	100.-SCR(13,ISH,LIN)-SCR(14,ISH,LIN)
C
	IF (QQ .GE. 100.)QQ=0.
	IF (RR .GE. 100.)RR=0.
	IF (SS .GE. 100.)SS=0.
C
C
C
C
C
	IF (ISH .EQ. 4) THEN
		CM=CMS(LIN)
		CM2=CM2S(LIN)
		CM3=CM3S(LIN)
		GO TO 555
	END IF
C
C
	IF (COMP(1,ISH,2,LIN) .EQ. 0) THEN
		IF (COMP(1,ISH,1,LIN) .EQ. 0) THEN
			CM=0
			CM2=0
			CM3=0
			GO TO 555
C
		ELSE
C
			CM=COMP(1,ISH,1,LIN)
			CM2=COMP(2,ISH,1,LIN)
		END IF
C
	ELSE
C
	CM=COMP(1,ISH,2,LIN)
	CM2=COMP(2,ISH,2,LIN)
C
	END IF
C
C
	IF (CM .NE. 0) THEN
C               
		CMS(LIN)=CM
		CM2S(LIN)=CM2
C                   
	END IF
C
C Use straight average between two halves for comp300
C
	IF (COMP2(3,ISH,1,LIN).LE.0 .AND. COMP2(3,ISH,2,LIN).LE.0) THEN
	  CM3=0	! Use neither
	ELSE
	  IF (COMP2(3,ISH,1,LIN).GT.0 .AND. COMP2(3,ISH,2,LIN).LE.0) THEN
	    CM3=COMP2(3,ISH,1,LIN)	! Use 1st half only
	  ELSE
	    IF (COMP2(3,ISH,1,LIN).LE.0 .AND. COMP2(3,ISH,2,LIN).GT.0) THEN
	      CM3=COMP2(3,ISH,1,LIN)	! Use 2nd half only
	    ELSE
	      CM3=(COMP2(3,ISH,1,LIN)+COMP2(3,ISH,2,LIN))/2. ! Straight avg
	    END IF
	  END IF
	END IF
C
C
C
C		save b.t.+1/4 for bill babich
C
	IF (ISH .NE. 4) THEN
C
		IF (NH .EQ. 2) THEN
C
			IF (RR .GE. 100) GO TO 555
C
	WJT(1,ISH,LIN)=SCR(1,ISH,LIN)+SCR(2,ISH,LIN)		!BT +1/2
	WJT(2,ISH,LIN)=RR					!BT +1/4
	WJT(3,ISH,LIN)=100.-(SCR(6,ISH,LIN)+SCR(7,ISH,LIN))	!BT +4M
	WJT(4,ISH,LIN)=SS                                       !AT +1/4
	WJT(5,ISH,LIN)=SCR(14,ISH,LIN)                          !-28M
	WJT(6,ISH,LIN)=CM                                       !COMPRESSION
	WJT(7,ISH,LIN)=CM2                                      !COMP. -200 
	WJT(8,ISH,LIN)=SILA(ISH,LIN)				!PEL. SIO2
	WJT(9,ISH,1)=F2A(1,ISH)					!S 2 FILT SIO2
	WJT(9,ISH,2)=F3A(1,ISH)					!S 3 FILT SI02
	WJT(10,ISH,LIN)=CM3					!COMP. -300
C
C
		END IF
	END IF
C
C
C patch 03/29-2000 added sd(ish,lin)
555	WRITE (6,20091,IOSTAT=MMV)AL(ISH),(SCR(M,ISH,LIN),M=1,4),
	1	SCR(5,ISH,LIN),SCR(6,ISH,LIN),SCR(7,ISH,LIN),
	1	(SCR(M,ISH,LIN),M=8,11),
	1	SCR(12,ISH,LIN),SCR(13,ISH,LIN),SCR(14,ISH,LIN),
	1	RR,SS,
	1	COMPT(1,ISH,LIN),COMPT(2,ISH,LIN),sd(ish,lin),
	1	(CABA(JA,ISH,LIN),JA=1,2),SILA(ISH,LIN)
C
2009	FORMAT (' ',A1,14F5.1,1X,2F6.1,1F7.0,3X,F4.0,2X,
	1		F4.1,2X,F4.2,F6.2,F7.2)
20091	FORMAT (' ',A1,14F5.1,1X,2F6.1,1F7.0,3X,F4.1,2X,f6.1,2x,
	1		F4.2,F6.2,F7.2)
C
C
C	  	collect dvj data
C
	IF (ISH .NE. 4) THEN
C
		IF (NH .EQ. 2) THEN
C
			DVJT(1,ISH,LIN)=SCR(1,ISH,LIN)+SCR(2,ISH,LIN)
			DVJT(2,ISH,LIN)=SCR(5,ISH,LIN)+SCR(4,ISH,LIN)+
	1	SCR(3,ISH,LIN)+SCR(2,ISH,LIN)+SCR(1,ISH,LIN)
			DVJT(3,ISH,LIN)=SCR(14,ISH,LIN)
			DVJT(4,ISH,LIN)=RR
			DVJT(5,ISH,LIN)=SS
			DVJT(6,ISH,LIN)=CM
			DVJT(7,ISH,LIN)=CM2
C
C
C
C
C
		IF (IFIL .NE. 1) GO TO 1107
C
CCCCCCCCC
C
C		collect [.ashift]forfile.dat data
C
		IF (LLX .EQ. 0) THEN
C
		FOR.BT(LIN,ISH)=RR	
		FOR.AT(LIN,ISH)=SS
		FOR.COMP(LIN,ISH)=CM
		FOR.PBA(LIN,ISH)=CABA(2,ISH,LIN)
		FOR.PSIL(LIN,ISH)=SILA(ISH,LIN)
		FOR.FCR(1,ISH)=F2A(6,ISH)
		FOR.FCR(2,ISH)=F3A(6,ISH)
C
C
C
		END IF
C   
		END IF
C
	END IF
C                       
C
C
C
C
1107	IF (IDEV .EQ. 1) THEN
	WRITE (61,20091,ERR=3000)AL(ISH),(SCR(M,ISH,LIN),M=1,4),
 	1	SCR(5,ISH,LIN),SCR(6,ISH,LIN),SCR(7,ISH,LIN),
	1	(SCR(M,ISH,LIN),M=8,11),
	1	SCR(12,ISH,LIN),SCR(13,ISH,LIN),SCR(14,ISH,LIN),
	1	RR,SS,
	1	COMPT(1,ISH,LIN),COMPT(2,ISH,LIN),SD(ISH,LIN),
	1	(CABA(JA,ISH,LIN),JA=1,2),SILA(ISH,LIN)
C
	END IF
C
C
C
C
3000	CONTINUE
C
C
CCCCCCCCCCCCCCCCCCCC
C
C	write out forfile.dat data
C
	IF ((IFIL .EQ. 1) .AND. (NH .EQ. 2)) THEN
C
		IF (LLX .EQ. 0) then
			REWRITE (50,ERR=9091) FOR
			CLOSE (50)
			llx=22
		end if
C
	END IF
C
CCCCCCCCCCCCCCCCCCCC
C
9091	WRITE (6,3001,IOSTAT=MMV)
3001	FORMAT (//'0','FILTER CAKE',13X,'STEP 2',21X,'FLUX',
	1 4x,'FINAL',6X,'STEP 3',
	1 34X,'FLUX',3X,'FLUX STONE'/' ',6X,
	1' SIO2   -270   -500  AMINE   CAO/MGO   B/A','   RATIO',
	1 3X,'CON MN',1X
	1,'SIO2   -270   -500  COLUMN  CAO/MGO   B/A','   RATIO',5X,'% -200M') 
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,3001)
	END IF
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C	5-3-99
C	get amine lbs/ton and %column part. from [metrep.cshift]
c	  shift_delays3.dat and put in old blaine columns
c
	OPEN (UNIT=72,FILE='USER_D:[METREP.CSHIFT]SHIFT_DELAYS.DAT',
	1	ACCESS='KEYED',STATUS='OLD',SHARED,ERR=1500)
C
	DO 2100 M=1,3
	WRITE (A3X,'(I1)')M
	READ (72,KEY=KD(3:8)//A3X,ERR=2100) DATQ
	IF (F2A(1,M) .GT. 0) BL2X(M)=DATQ.AMINE
	IF (F3A(1,M) .GT. 0) BL3X(M)=DATQ.CCP
2100	CONTINUE
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
1500	CLOSE (72)
C
cccccccccccccccccccccccccccccccccccccccccc
C
C  get flot conc MN
C
	
C	OPEN STRUKEL'S FLOT CONC AND FEED FILE
C
460	OPEN (UNIT=65,FILE='MET_P:MMC.DAT',ACCESS='KEYED',STATUS='OLD',
	1		SHARED)
C
	LLK=0
	GLS=0
	DO 2160 M=1,3
	WRITE (A3X,'(I1)')M
	read (65,KEY=kd(3:8)//a3x,IOSTAT=JKL) FFD	!get latest record to 
C					        get latest date-shift
	IF (F2A(1,M) .GT. 0 .OR. F3A(1,M) .GT. 0) FCMN(M)=FFD.FCDATA(5)
	IF (FCMN(M) .GT. 0) THEN
		LLK=LLK+1
		GLS=GLS+FCMN(M)
	END IF 
CCCCCCCC	IF (F3A(1,M) .GT. 0) BL3X(M)=DATQ.CCP
2160	CONTINUE
C
	IF (LLK .GT. 0) THEN
		FCMN(4)=GLS/LLK
	ELSE
		FCMN(4)=0
	END IF
c
	CLOSE (65)
C
C
cccccccccccccccccccccccccccccccccccccccccc
C
C
	DO 4000 ISH=1,4  
C
	IF (ISH .NE. 4) THEN
C
	WRITE (6,3002,IOSTAT=MMV)AL(ISH),
	1(F2A(M,ISH),M=1,3),BL2X(ISH),(F2A(M,ISH),M=4,6),
	1 FCMN(ISH),
	1(F3A(M,ISH),M=1,3),BL3X(ISH),(F3A(M,ISH),M=4,6)
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,3002,IOSTAT=MMV)AL(ISH),
	1(F2A(M,ISH),M=1,3),BL2X(ISH),(F2A(M,ISH),M=4,6),
	1 FCMN(ISH),
	1(F3A(M,ISH),M=1,3),BL3X(ISH),(F3A(M,ISH),M=4,6)
CCCCC	WRITE (61,3002)AL(ISH),(F2A(M,ISH),M=1,6),(F3A(M,ISH),M=1,6)
CCCCC	WRITE (62,3003) (F2A(M,ISH),M=1,3),(F3A(M,ISH),M=1,3)
	END IF
C
3002	FORMAT (' ',A1,3X,3F7.2,2X,F6.3,2X,2F7.2,F7.4,
	1 3X,F5.2,1X,
	1 F5.2,2F7.2,2X,F6.2,2X,2F7.2,F7.4)
3003	FORMAT (2(3F6.2,6X),66X)
C
	ELSE
C
	WRITE (6,3022,IOSTAT=MMV)AL(ISH),(F2A(M,ISH),M=1,3),BL2X(4),
	1	(F2A(M,ISH),M=4,6),
	1 FCMN(4),
	1(F3A(M,ISH),M=1,3),BL3X(4),(F3A(M,ISH),M=4,6)
	1	,FLUXG                                  
C
cccc  patch ccccc
ccccc	WRITE (6,3099,IOSTAT=MMV)
3099	FORMAT ('1')
C
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,3022,IOSTAT=MMV)AL(ISH),(F2A(M,ISH),M=1,3),BL2X(4),
	1	(F2A(M,ISH),M=4,6),
	1 FCMN(ISH),
	1 (F3A(M,ISH),M=1,3),BL3X(4),(F3A(M,ISH),M=4,6)
	1	,FLUXG                                  
CCCC	WRITE (61,3022)AL(ISH),(F2A(M,ISH),M=1,3),BL2,
CCCC	1	(F2A(M,ISH),M=4,6),(F3A(M,ISH),M=1,3),BL3,(F3A(M,ISH),M=4,6)
CCCC	1	,FLUXG
CCCC3022	FORMAT (' ',A1,3X,2(3F7.2,2X,F6.3,2X,2F7.2,F7.4,7X),F5.2)
3022	FORMAT (' ',A1,3X,3F7.2,2X,F6.3,2X,2F7.2,F7.4,
	1 3X,F5.2,1X,
	1 F5.2,2F7.2,2X,F6.2,2X,2F7.2,F7.4,7X,F5.2)
ccccccc	WRITE (61,3099)
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
588	IF (IFIL .EQ. 1) THEN
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	  collect data for spc charts
C
C
CC	STATUS=LIB$SPAWN ('RUN USER_D:[METREP.GKS]LABDAT42N')
CC  	STATUS=LIB$SPAWN ('SUBMIT/NOLOG USER_D:[METREP.GKS]SPC.COM')
CC  	STATUS=LIB$SPAWN ('SUBMIT/NOLOG USER_D:[METREP.GKS]SPC3.COM')
CC  	IF (.NOT. STATUS) CALL LIB$SIGNAL(%VAL(STATUS))
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
	END IF
C
C
C
C
C	close out doug's data
C
	IF ((IFIL .EQ. 1) .AND. (NH .EQ. 2)) THEN
C
C         steps 1 & 2
C
	DO 499 KS=1,3	!shift
	DO 499 I=1,7    !data
		DN=0
		DSM=0
		DO 498 J=1,3    !lines
C
			IF (DVJT(I,KS,J) .LE. 0) GO TO 498
C
			DN=DN+1
			DSM=DSM+DVJT(I,KS,J)
C
498		CONTINUE
C
		IF (DN .GT. 0) DVJ(I,KS,1,31)=DSM/DN
C
499	CONTINUE
C
C
C         steps 3
C
	DO 3499 KS=1,3	!shift
	DO 3499 I=1,7    !data
		DN=0
		DSM=0
		DO 3498 J=4,5    !lines
C
			IF (DVJT(I,KS,J) .LE. 0) GO TO 3498
C
			DN=DN+1
			DSM=DSM+DVJT(I,KS,J)
C
3498		CONTINUE
C
		IF (DN .GT. 0) DVJ(I,KS,2,31)=DSM/DN
C
3499	CONTINUE
C
C
	WRITE (22,REC=2) DVJ
C
	CLOSE (22)
C
C
	END IF
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	send float sio2 and grind across link to 1353000,B,BMG
C
	OPEN (UNIT=89,FILE='MET_P:FLOAT',RECL=20,FORM='UNFORMATTED',
	1RECORDTYPE='FIXED',STATUS='UNKNOWN')
C	,SHARED,USEROPEN=UFO_OPEN)
C
	READ (89,ERR=477) FS,F2
C
477	CLOSE (89)
C
CCCCCC	WRITE (62,3023) (F2A(M,ISH),M=1,3),BL2,(F3A(M,ISH),M=1,3),BL3,FS,F2
C
	END IF
C                              
3023	FORMAT (3F6.2,F6.0,3F6.2,F6.0,2F6.2,54X)
C
C
	END IF        
C
4000	CONTINUE
C
	CLOSE (6)
C
797	CONTINUE
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C                       
C
6014	IF (IFIL .NE. 1) THEN
	WRITE (6,*) ' '
	CALL LIB$SPAWN ('SET TERM/WIDTH=80',,,flag)	
		STOP
	END IF                                           
C             
C	IF (IFIL .EQ. 1) THEN  !request from metinput if ifil=1
C
C		JJCNT=JJCNT+1
C                     
C		IF (JJCNT .EQ. 2) GO TO 654
C       
		CLOSE (61)
C
C		GO TO 401
C
C	ELSE
C
C		STOP
C
C	END IF
C
C
C	SECTION TO SEND DATA TO BMH VIA TERM. SERVER
C
	WRITE (6,2822)
2822	FORMAT('0SENDING DATA TO STEP 3 AGGLOM, PLEASE WAIT')
C
C
c patch 10/13/04
654	continue
ccc654	STATUS=LIB$SPAWN ('PRINT/QUE=BMHPRINT USER_D:[METREP]SFIL2.LIS',
ccc	1,,FLAGS,,,,,,,,)
C
c patch 10/13/04
ccc	STATUS=LIB$SPAWN ('PRINT/QUE=CPSAG2F/PARA=PAGE_O=LANDS
ccc	1 USER_D:[METREP]SFIL2.LIS',
ccc	1,,FLAGS,,,,,,,,)
C
ccc	IF (.NOT. STATUS) CALL LIB$SIGNAL(%VAL(STATUS))
C
C
C	
	CALL LIB$SPAWN ('SET TERM/WIDTH=80',,,flag)	
C
c	STATUS=SYS$CREPRC (,'SYS$SYSTEM:LOGINOUT.EXE',
c	1	'USER_D:[METREP.LAB45]ORACLE_SPAWN.COM','NL:','NL:',
c	1	,PRV$V_DETACH,,,MEM,,)
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C		section to send bt+1/4 to wjb
C
	IF (NH .EQ. 2) THEN	!see if its second half of shift
C
C
C
		OPEN (UNIT=78,FILE='MET_P:WJBBTX.DAT',STATUS='old',
	1	recordtype='fixed',recl=200,SHARED,USEROPEN=UFO_OPEN)
CCC
C Step 2 data
CCC
C
C Clear weighted average array
C
	DO 3811 I=1,8
3811	WAV(I)=0.
	WAV(10)=0.
C
C Populate comp and comp200 data
C
	M=0
	DO 322 LA=6,7
	DO 322 I=1,3
		IF (LA .EQ. 6) THEN
		IF (WJT(LA,NS,I) .LT. MINCOMP(LA-5)) GO TO 322
		WAV(LA)=WAV(LA)+WJT(LA,NS,I)
		MQ(LA)=MQ(LA)+1
		ELSE IF (LA .EQ. 7) THEN
		IF (WJT(LA,NS,I) .GT. MINCOMP(LA-5)) GO TO 322
		IF (WJT(LA,NS,I) .le. 0) GO TO 322
		WAV(LA)=WAV(LA)+WJT(LA,NS,I)
		MQ(LA)=MQ(LA)+1
		END IF
322	CONTINUE
C
	DO 729 I=6,7
	IF (MQ(I) .EQ. 0) GO TO 729
C
	WAV(I)=WAV(I)/MQ(I)
729	CONTINUE
C
C Populate total tons
C
	XX2=(TBSS(NS,1)+TBSS(NS,2)+TBSS(NS,3))
	IF (XX2 .LE. 0) GO TO 4744
C
C Populate weighted average based on tons
C
	DO 1911 M=1,5
	WAV(M)=(WJT(M,NS,1)*TBSS(NS,1)+WJT(M,NS,2)*TBSS(NS,2)+
	1		WJT(M,NS,3)*TBSS(NS,3))/XX2
1911	CONTINUE
C
	WAV(8)=(WJT(8,NS,1)*TBSS(NS,1)+WJT(8,NS,2)*TBSS(NS,2)+
	1		WJT(8,NS,3)*TBSS(NS,3))/XX2
C
C Populate comp300 data
C
	WAV(10)=(WJT(10,NS,1)*TBSS(NS,1)+WJT(10,NS,2)*TBSS(NS,2)+
	1		WJT(10,NS,3)*TBSS(NS,3))/XX2
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C Step 3 data
CCC
C
C Clear weighted average array
C
4744	DO 3812 I=1,8
	MQ(I)=0
3812	WAV3(I)=0.
	WAV3(10)=0.
C
C Populate comp and comp200 data
C
	M=0
	DO 363 LA=6,7
	DO 363 I=4,5
		WAV3(LA)=WAV3(LA)+WJT(LA,NS,I)
		IF (WJT(LA,NS,I) .GT. 0) MQ(LA)=MQ(LA)+1
363	CONTINUE
C
	DO 7729 I=6,7
	IF (MQ(I) .EQ. 0) GO TO 7729
C
	WAV3(I)=WAV3(I)/MQ(I)
7729	CONTINUE
C
C Populate total tons
C
	XX3=(TBSS(NS,4)+TBSS(NS,5))
	IF (XX3 .LE. 0) GO TO 3744
C
C Populate weighted averages based on tons
C
	DO 3911 M=1,5
	WAV3(M)=(WJT(M,NS,4)*TBSS(NS,4)+WJT(M,NS,5)*TBSS(NS,5))/XX3
3911	CONTINUE
C
	WAV3(8)=(WJT(8,NS,4)*TBSS(NS,4)+WJT(8,NS,5)*TBSS(NS,5))/XX3
C
C Populate comp300 data
C
	WAV3(10)=(WJT(10,NS,4)*TBSS(NS,4)+WJT(10,NS,5)*TBSS(NS,5))/XX3
C
C Populate filter cake sio2
C
3744	WAV(9)=WJT(9,NS,1)	!ST 2 FILT SIO2
	WAV3(9)=WJT(9,NS,2)	!ST 3 FILT SIO2
C
1199	WRITE (AS,'(I1)')NS	!convert shift to ascii
C
C Write data to WJBBTX file
C
	WRITE (78,255)TIMBUF(1:11),AS,(WAV(I5),I5=1,9),
	1		(WAV3(J),J=1,9),FS,F2,XX2,XX3,WAV(10),WAV3(10)
255	FORMAT (A11,A1,20F7.2,2f7.1,2F7.2)
C
	CLOSE (78)
c
C Kick off BTUM program to process WJBBTX data
C
		CALL	SYS$CREPRC(,BTUM,,,,,,BTUM,%VAL(4),,,
	1		%VAL(PRC$M_DETACH.OR.PRC$M_NOACNT))
C
C
C
	END IF
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	put data into daily met report files
C
C
C
	IF (.NOT.((RECNO .EQ. 2) .AND. (IFIL .EQ. 1))) GO TO 621
C                      
C
C
C
	OPEN   (UNIT=10,FILE=FIL(1)//TIMBUF(1:2)//DATJ,STATUS='UNKNOWN',
	1	FORM='UNFORMATTED')
C
	OPEN   (UNIT=11,FILE=FIL(2)//TIMBUF(1:2)//DATJ,STATUS='UNKNOWN',
	1	FORM='UNFORMATTED')
C                    
C
	READ (10,ERR=600)OIC2
C                           
600	READ (11,ERR=601)OIC3
C
601	DO 1000 LN=1,3
C
	N=(LN-1)*10+1
C                                       
	OIC2(N)		=SCR(1,4,LN)+SCR(2,4,LN)
	OIC2(N+1)	=SCR(3,4,LN)
	OIC2(N+2)  	=SCR(4,4,LN)
cccc		OIC2(N+3)	=SCR(5,4,LN)+SCR(6,4,LN)
	OIC2(N+3)	=SCR(6,4,LN)
	OIC2(N+4)	=SCR(7,4,LN)
C
	OIC2(N+5)	=SCR(8,4,LN)+SCR(9,4,LN)
	OIC2(N+6)	=SCR(10,4,LN)
	OIC2(N+7)	=SCR(11,4,LN)
cccccc		OIC2(N+8)	=SCR(12,4,LN)+SCR(13,4,LN)
	OIC2(N+8)	=SCR(13,4,LN)
	OIC2(N+9)	=SCR(14,4,LN)
C               
C
1000	CONTINUE
C
C
	OIC2(41) =SCR(5,4,1)
	OIC2(42) =SCR(12,4,1)
	OIC2(113)=SCR(5,4,2)   	! 4 MESH   (NOW 1/4 MESH)
	OIC2(114)=SCR(5,4,3)
	OIC2(115)=SCR(12,4,2)
	OIC2(116)=SCR(12,4,3)
C
C
C
	OIC2(31)=CMS(1)
	OIC2(32)=CMS(2)
	OIC2(33)=CMS(3)
C
	OIC2(34)=CM2S(1)
	OIC2(35)=CM2S(2)
	OIC2(36)=CM2S(3)
C
CCCC	OIC2(38)=CM3S(1)
CCCC	OIC2(39)=CM3S(2)
C
	OIC2(43)=SILA(4,1)
	OIC2(44)=SILA(4,2)
	OIC2(45)=SILA(4,3)
C
 	OIC2(47)=F2A(1,4)
	OIC2(48)=BL2
	OIC2(49)=F2A(2,4)
	OIC2(50)=F2A(3,4)
C
	OIC2(105)=CABA(1,4,1)
	OIC2(106)=CABA(1,4,2)
	OIC2(107)=CABA(1,4,3)
C
	OIC2(108)=CABA(2,4,1)
	OIC2(109)=CABA(2,4,2)
	OIC2(110)=CABA(2,4,3)
C
	OIC2(111)=F2A(4,4)
	OIC2(112)=F2A(5,4)
C
	REWIND (10)
C
	WRITE (10) OIC2
C
	CLOSE (10)
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
c
C	  bring in steps 1,2 & 3 rmf shift tons
c
c
	OPEN (UNIT=38,FILE='MET_P:SHIFT_RMF.DAT',STATUS='UNKNOWN',
	1	ACCESS='DIRECT',FORM='UNFORMATTED',RECL=4,ERR=908)
C
	TTS=0
	TA(1)=0
	TA(2)=0
C
	TRIP=0
	ASUM=0
	AN=0
C
C
	DO 368 N=1,3
		READ (38,REC=N,ERR=908)T1,T2
C
		TTS=TTS+(T1+T2)
C
		TA(1)=TA(1)+FSI(1,N)*(T1+T2)
		TA(2)=TA(2)+FSI(2,N)*(T1+T2)
C
C
C	  see if there are tons and no flot sio2 or vice-versa
C
		IF (((T1+T2) .LE. 0) .AND. (FSI(1,N) .GT. 0)) TRIP=TRIP+1
		IF (((T1+T2) .GT. 0) .AND. (FSI(1,N) .LE. 0)) TRIP=TRIP+1
C
		IF (FSI(1,N) .GT. 0) THEN
			AN=AN+1.
			ASUM=ASUM+FSI(1,N)
		END IF
368	CONTINUE
C
C
	IF (TTS .LE. 0) GO TO 908
C
C
C
	IF (TRIP .EQ. 0) THEN
C
		TA(1)=TA(1)/TTS  	! WTD. AVERAGE FLOT SIO2
		TA(2)=TA(2)/TTS          ! AVERAGE FLOT -270
C
	ELSE
C
		IF (AN .LE. 0) GO TO 908
C
		TA(1)=ASUM/AN		! ARITH. AVG FLOT SIO2
C
	END IF
C
C
C	
	
908	CLOSE (38)
C
c
c
c
c
C
C	section to open amicon.dat file and put flux -200 in it
c
c
C
	OPEN   (UNIT=10,FILE=FIL(3)//TIMBUF(1:2)//DATJ,STATUS='UNKNOWN',
	1	FORM='UNFORMATTED',ERR=8657)
C
	READ (10,ERR=739)OIC2
C
739	OIC2(115)=FLUXG
	OIC2(99)=TA(1)
	OIC2(133)=TA(2)	!LAB FLOT FEED -270
C
	REWIND (10)
	WRITE (10)OIC2
	CLOSE (10)
C
C
C
C
C
8657	OPEN   (UNIT=17,FILE=FIL(4)//TIMBUF(1:2)//DATJ,STATUS='UNKNOWN',
	1	FORM='UNFORMATTED',ERR=8658)
C
	READ (17,ERR=7394)OIC2
C
7394	OIC2(56)=TA(1)
	OIC2(57)=TA(2)
C
	REWIND (17)
	WRITE (17)OIC2
	CLOSE (17)
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C		STEP 3
C
C
8658	DO 2000 LN=4,5
C
	N=(LN-4)*10+1
C
	OIC3(N)		=SCR(1,4,LN)+SCR(2,4,LN)
	OIC3(N+1)	=SCR(3,4,LN)
	OIC3(N+2)	=SCR(4,4,LN)
CCCCCC		OIC3(N+3)	=SCR(5,4,LN)+SCR(6,4,LN)
	OIC3(N+3)	=SCR(6,4,LN)
	OIC3(N+4)	=SCR(7,4,LN)
C
	OIC3(N+5)	=SCR(8,4,LN)+SCR(9,4,LN)
	OIC3(N+6)	=SCR(10,4,LN)
	OIC3(N+7)	=SCR(11,4,LN)
CCCCC		OIC3(N+8)	=SCR(12,4,LN)+SCR(13,4,LN)
	OIC3(N+8)	=SCR(13,4,LN)
	OIC3(N+9)	=SCR(14,4,LN)
C
C
2000	CONTINUE
C
	OIC3(96)=SCR(5,4,4) 	! 4 MESH    (NOW 1/4 MESH)
	OIC3(97)=SCR(5,4,5)
	OIC3(98)=SCR(12,4,4)
	OIC3(99)=SCR(12,4,5)
C
C
	OIC3(21)=CMS(4)
	OIC3(22)=CMS(5)
C
	OIC3(23)=CM2S(4)
	OIC3(24)=CM2S(5)
C
ccc	OIC3(25)=CM3S(4)
ccc	OIC3(26)=CM3S(5)
C                    
	OIC3(29)=SILA(4,4)
	OIC3(30)=SILA(4,5)
C
	OIC3(32)=F3A(1,4)
8	OIC3(33)=BL3
	OIC3(34)=F3A(2,4)
	OIC3(35)=F3A(3,4)
C
C
	OIC3(90)=CABA(1,4,4)
	OIC3(91)=CABA(1,4,5)
C
	OIC3(92)=CABA(2,4,4)
	OIC3(93)=CABA(2,4,5)
C                        
	OIC3(94)=F3A(4,4)
	OIC3(95)=F3A(5,4)
C
	REWIND (11)
C
	WRITE (11) OIC3
C
	CLOSE (11)
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
621	IF (IFIL .NE. 1) STOP
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C		loop to convert data to ascii and store it in adp(352)
C
C
C
	CALL SYS$NUMTIM (TDATA,DAT)
C
	LD=TDATA(3)
	LM=TDATA(2)
	LY=TDATA(1)
C
	LY=MOD(LY,100)
C
	WRITE (DATT(1:2),'(I2)')LD
	WRITE (DATT(3:4),'(I2)')LM          
	WRITE (DATT(5:6),'(I2)')LY
C
	IF (DATT(1:1) .EQ. ' ')DATT(1:1)='0'
	IF (DATT(3:3) .EQ. ' ')DATT(3:3)='0'
C
	CODE(1)='0'
	CODE(2)='0'
	CODE(3)='0'
C
C
C
	IF ((IS .EQ. 3) .AND. (IH .EQ. 2)) THEN
C
		CODE(1)='3'
		CODE(2)='3'
		CODE(3)='3'
C           
C
	ELSE
C
		IF ((IS .EQ. 1).AND.(IH .EQ. 1)) THEN
C
			CODE(1)='1'
C
			GO TO 3399
C
		END IF 
C
		IF ((IS .EQ. 1) .AND. (IH .EQ. 2)) THEN
C
			CODE(1)='3'
			GO TO 3399
		END IF
C
		IF ((IS .EQ. 2) .AND. (IH .EQ. 1)) THEN
C
			CODE(1)='3'
			CODE(2)='1'
C
			GO TO 3399
C
		END IF 	
C
		IF ((IS .EQ. 2) .AND. (IH .EQ. 2)) THEN
C
			CODE(1)='3'
			CODE(2)='3'
C
			GO TO 3399
C
		END IF 	
C
		IF ((IS .EQ. 3) .AND. (IH .EQ. 1)) THEN
C
			CODE(1)='3'
			CODE(2)='3'
			CODE(3)='1'
C
			GO TO 3399
C
		END IF 	
C
C
	END IF
C
C
C
CCCCC3399	WRITE (62,23)DATT,(CODE(I5),I5=1,3)
C                                  
C
C
CCCCC	CLOSE (62)
C
23	FORMAT (A6,3A1,105X)
C
CCCCCCCCCCCCCCCCCCCCCC
C
3399	WRITE (6,2119)
2119	FORMAT ('0WAITING 10 SECONDS BETWEEN LINK CALLS,PLEASE WAIT')
C
cccc	CALL LIB$WAIT (10.)
C
CCCCCCCCCCCCCCCCCCCCCC
C
C
C
2855	IF (RECNO .EQ. 2) THEN
C
		CLOSE (61)
		CALL LIB$SPAWN ('RUN MET_P:STRUKEL',,,flag)
C
	END IF
C
	CALL LIB$SPAWN ('SET TERM/WIDTH=80',,,flag)	
C
	STOP 
C
cc5881	CLOSE (6)	
cc	WRITE (6,*) 'OUTPUT PROBLEM, LOOK FOR BAD NUMBERS'
cc	CALL LIB$WAIT(5.)
C
C
	END
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
	SUBROUTINE COMP_STD_DEV (YYMMDD,SHIFT,HALF,SD)
C
C	THIS SUBROUTINE RETURNS THE STANDARD DEVIATION OF ALL COMPRESSION
C	READINGS FOR THE DATE ENTERED. IT CALCULATES FROM SHIFT 1 HALF 1
C	THRU SHIFT(SHIFT) AND HALF(HALF).  SD(SHIFTS,LINES)
C
C
C
	CHARACTER YYMMDD*6,KY*9
	INTEGER LINE,SHIFT,HALF
	REAL SD1,SD2,SD3
	DOUBLE PRECISION N(3,7),DSUM(3,7),DSUM2(3,7),SD(3,7)
C
C
	STRUCTURE /CT2/
C
		CHARACTER*9	KEY		!YYMMDD LINE SHIFT HALF
		REAL		VALUES(100)
		REAL		MEAN,SD,CA200,A200,MIN,MAX,NUM
		INTEGER 	SAMPLE
		INTEGER 	REP
C
	END STRUCTURE
C
	RECORD /CT2/ CT
C
C
	KY=YYMMDD//'111'
C
	DO 15 J=3,7
	DO 15 I=1,3
		SD(I,J)=0
15	CONTINUE
C
	IF (HALF .GT. 2 .OR. HALF .LT. 1) RETURN
	IF (SHIFT .GT. 3 .OR. SHIFT .LT. 1) RETURN
C
	OPEN (UNIT=11,FILE='D_I:COMPSAVE.DAT',ORGANIZATION='INDEXED',
	1		FORM='UNFORMATTED',ACCESS='KEYED',RECL=128,
	1		RECORDTYPE='FIXED',SHARED,
	1		STATUS='UNKNOWN',KEY=(1:9:CHARACTER),ERR=99)
C
c
c
c
	DO 154 J=3,7
	DO 154 I=1,3
		N(I,J)=0
		DSUM(I,J)=0
		DSUM2(I,J)=0
154	CONTINUE
c
	DO 3000 LN=3,7
	DO 2000 LS=1,SHIFT
		IF (LS .EQ. SHIFT) THEN
			MM=1
			IF (HALF .EQ. 2) MM=2
		ELSE
			MM=2
		END IF
C
C
	DO 1000 LH=1,MM
C
		WRITE (KY(7:7),'(I1)') LN
		WRITE (KY(8:8),'(I1)') LS
		WRITE (KY(9:9),'(I1)') LH
		KY=YYMMDD//KY(7:9)
C
		READ (11,KEY=KY,IOSTAT=MM) CT
C
		IF (MM .NE. 0) GO TO 1000
C
C
	     DO 444 M=1,CT.NUM
C
		IF (CT.VALUES(M) .LE. 90) GO TO 444
		N(LS,LN)=N(LS,LN)+1
		DSUM(LS,LN)=DSUM(LS,LN)+CT.VALUES(M)
		DSUM2(LS,LN)=DSUM2(LS,LN)+CT.VALUES(M)**2
444	     CONTINUE
C
C
1000	CONTINUE
2000	CONTINUE
3000	CONTINUE
C
C
C
	DO 200 LN=3,7
	DO 100 LS=1,3
C
	IF (N(LS,LN) .LT. 2) THEN
		SD(LS,LN)=0
		GO TO 100
	END IF
C
	SD(LS,LN)=DSQRT((N(LS,LN)*DSUM2(LS,LN)-DSUM(LS,LN)**2)/
	1		(N(LS,LN)*(N(LS,LN)-1)))
C
100	CONTINUE
200	CONTINUE
C
C
C
99	RETURN
	END
