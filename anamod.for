C
C
	PROGRAM ANAMOD
C
C	THIS PROGRAM MAINTAINS THE CONVERSION DATA BASE
C	FOR ALL PULSE, ANALOGS AND CALCULATIONS PROCESSED
C	BY THE PROCESS SCANNER PROGRAM
C
	IMPLICIT NONE
C
	INTEGER*4	LEN,POINT,I,J,K,L,FUNC,ALARM(300)
	REAL*4		SECONDS/5.0/
C
	INTEGER*4	UFO_OPEN
	INTEGER*4	PT,ET,SC,RCX,ACPOINT(6),INTC(4)
	REAL*4		REALC,LL,HL
	CHARACTER	PN*8,EU*6,ED*30,CH*1,CL*1
C
	COMMON/ALARMTBL/ALARM
C
	EXTERNAL	UFO_OPEN
C
	OPEN	(UNIT=2,NAME='ANAMOD.DAT',FORM='UNFORMATTED',
	1	ACCESS='DIRECT',STATUS='OLD',RECL=20,SHARED,
	1	RECORDTYPE='FIXED',USEROPEN=UFO_OPEN)
	OPEN	(UNIT=3,FILE='ANAPHR.DAT',FORM='FORMATTED',
	1	ACCESS='DIRECT',STATUS='OLD',RECL=44,SHARED,
	1	RECORDTYPE='FIXED',USEROPEN=UFO_OPEN)
C
4	CONTINUE
	CALL	CLRSCREEN	!CLEAR SCREEN AND POSITION CURSOR
C
5	CONTINUE
	WRITE	(6,10)
10	FORMAT	(' TYPE PROCESS POINT NO. (1 THRU 1200)...RETURN TO QUIT'/)
	READ	(5,20)LEN,POINT
20	FORMAT	(Q,I4)
	IF (LEN .EQ. 0) GOTO 4000
	IF ((POINT .LT. 1).OR.(POINT .GT.1200)) THEN
		WRITE	(6,30)
30		FORMAT	(' INCORRECT PROCESS POINT NO.')
		GOTO 5
	END IF
C
	READ	(2,REC=POINT)PT,ET,SC,RCX,LL,HL,ACPOINT,
	1	INTC,REALC
	READ	(3,33,REC=POINT)PN,ED,EU
33	FORMAT	(A,A,A)
C
35	CONTINUE
	CALL	CLRSCREEN
		WRITE	(6,40)
40		FORMAT	(' POINT TYPE =             1 ')
		WRITE	(6,41)
41		FORMAT	(' EQUATION TYPE =          2 ')
		WRITE	(6,42)
42		FORMAT	(' SCAN RATE =              3 ')
		WRITE	(6,43)
43		FORMAT	(' RELATED CX =             4 ')
		WRITE	(6,44)
44		FORMAT	(' ALARM LIMITS =           5 ')
		WRITE	(6,46)
46		FORMAT	(' ANA/CX DATA POINTS =     6 ')
		WRITE	(6,47)
47		FORMAT	(' INTEGER CONSTANTS =      7 ')
		WRITE	(6,48)
48		FORMAT	(' REAL CONSTANTS =         8 ')
		WRITE	(6,49)
49		FORMAT	(' ENGLISH DESCRIPTION =    9 ')
		WRITE	(6,50)
50		FORMAT	(' ENG UNITS =              10 ')
		WRITE	(6,51)
51		FORMAT	(' WDPF ID =                11 ')
		WRITE	(6,54)
54		FORMAT	(' SET CRITICAL ALARMING =  12 ')
		WRITE	(6,52)
52		FORMAT	(' DISPLAY POINT DATA =     13 ')
		WRITE	(6,53)
53		FORMAT	(' .....PRESS RETURN KEY FOR NEW POINT... ')
C
	CALL	LIB$SET_CURSOR(14,1)
	READ	(5,70)LEN,FUNC
70	FORMAT	(Q,I2)
	IF (LEN .EQ. 0) GOTO 3500
	IF	((FUNC .LT.1).OR.(FUNC .GT.13)) THEN
		WRITE	(6,80)
80		FORMAT	(' INCORRECT FUNCTION ')
		CALL	LIB$WAIT(SECONDS)
		GOTO 35
	END IF
C
	CALL	CLRSCREEN
	GOTO (100,200,300,400,500,600,700,800,900,1000,1100,1300,1200)FUNC
C
100	CONTINUE
	WRITE	(6,101)
101	FORMAT	(' ENTER POINT TYPE (0 THRU 3) ')
	READ	(5,102)PT
102	FORMAT	(I1)
	IF ((PT .LT.0).OR. (PT .GT. 3)) THEN
		WRITE	(6,103)
103		FORMAT(' INCORRECT POINT TYPE ')
		GOTO 100
	END IF
	GOTO 3500
C
200	CONTINUE
	WRITE	(6,201)
201	FORMAT	(' ENTER EQUATION TYPE (0 THRU 7) ')
	READ	(5,202)ET
202	FORMAT	(I1)
	IF ((ET .LT. 0).OR.(ET .GT.8)) THEN
		WRITE	(6,203)
203		FORMAT(' INCORRECT EQUATION TYPE ')
		GOTO 200
	END IF
	GOTO 3500
C
300	CONTINUE
	WRITE	(6,301)
301	FORMAT	(' ENTER SCAN RATE (0 OR 1) ')
	READ	(5,302)SC
302	FORMAT	(I2)
	IF ((SC .LT. 0).OR.(SC .GT.1)) THEN
		WRITE	(6,303)
303		FORMAT	(' INCORRECT SCAN RATE ')
		GOTO 300
	END IF
	GOTO 3500
C
400	CONTINUE
	WRITE	(6,401)
401	FORMAT	(' ENTER RELATED CONTACT ')
	READ	(5,402)RCX
402	FORMAT	(I6)
	GOTO 3500
C
500	CONTINUE
	WRITE	(6,501)
501	FORMAT	(' ENTER LOW LIMIT,HIGH LIMIT ')
	READ	(5,502)LL,HL
502	FORMAT	(2F9.2)
	GOTO 3500
C
600	CONTINUE
	WRITE	(6,601)
601	FORMAT	(' ENTER UP TO 6 ANA OR CX POINTS ')
	READ	(5,602)ACPOINT
602	FORMAT	(6I6)
	GOTO 3500
C
700	CONTINUE
	WRITE	(6,701)
701	FORMAT	(' ENTER UP TO 4 INTEGER CONSTANTS (2 DIGIT) ')
	READ	(5,702)INTC
702	FORMAT	(4I4)
	GOTO 3500
C
800	CONTINUE
	WRITE	(6,801)
801	FORMAT	(' ENTER REAL CONSTANT ')
	READ	(5,802)REALC
802	FORMAT	(F11.5)
	GOTO 3500
C
900	CONTINUE
	WRITE	(6,901)
901	FORMAT	(' ENTER ENGLISH DESCRIPTION (30 CHARS) ')
	READ	(5,902)ED
902	FORMAT	(A)
	GOTO 3500
C
1000	CONTINUE
	WRITE	(6,1001)
1001	FORMAT	(' ENTER ENG UNITS (6 CHARS) ')
	READ	(5,1002)EU
1002	FORMAT	(A)
	GOTO 3500
C
1100	CONTINUE
	WRITE	(6,1101)
1101	FORMAT	(' ENTER WDPF ID (8 CHARS( ')
	READ	(5,1102)PN
1102	FORMAT	(A)
	GOTO 3500
C
1200	CONTINUE
	J=((POINT-1)/4)+1	!ALARM TABLE LONGWORD
	IF (MOD(POINT,4) .EQ. 0)THEN
		K=24
	ELSE
		K=(MOD(POINT,4)-1)*8	!START OF 8 BIT BLOCK
	END IF
C
	IF (BJTEST(ALARM(J),K+3))THEN
		CL='C'
	ELSE
		CL=' '
	END IF
C
	IF (BJTEST(ALARM(J),K+4))THEN
		CH='C'
	ELSE
		CH=' '
	END IF
C
	CALL	CLRSCREEN
	WRITE	(6,1211)POINT
1211	FORMAT	(' PROCESS POINT ',I6,/)
	WRITE	(6,1201)PT
1201	FORMAT	(' POINT TYPE         ',I1)
	WRITE	(6,1202)ET
1202	FORMAT	(' EQUATION TYPE      ',I1)
	WRITE	(6,1203)SC
1203	FORMAT	(' SCAN RATE          ',I1)
	WRITE	(6,1204)RCX
1204	FORMAT	(' RELATED CX         ',I6)
	WRITE	(6,1205)LL,CL,HL,CH
1205	FORMAT	(' ALARM LIMITS       ',2(F10.2,2X,A))
	WRITE	(6,1206)ACPOINT
1206	FORMAT	(' ANA/CX POINTS      ',6I7)
	WRITE	(6,1207)INTC
1207	FORMAT	(' INTEGER CONSTANTS  ',4I3)
	WRITE	(6,1208)REALC
1208	FORMAT	(' REAL CONSTANT      ',F11.5)
	WRITE	(6,1209)ED
1209	FORMAT	(' ENGLISH DESC.       ',A)
	WRITE	(6,1210)EU
1210	FORMAT	(' ENG. UNITS        ',A)
	WRITE	(6,1218)PN
1218	FORMAT	(' WDPF ID.     ',A)
1220	WRITE	(6,1213)
1213	FORMAT	(' ...PRESS RETURN KEY TO RETURN TO MENU... ')
	READ	(5,1212)LEN
1212	FORMAT	(Q)
	IF (LEN .EQ. 0) GOTO 35
	GOTO 1220
C
1300	WRITE	(6,1310)
1310	FORMAT	(' YES = Y ... NO = N'/,
	1	 ' INDICATE LOW SIDE,HIGH SIDE')
	READ	(5,1320)LEN,CL,CH
1320	FORMAT	(Q,A1,A3)
	IF (LEN .EQ. 0)GOTO 4
	IF ((CH .NE. 'Y').OR.(CH .NE. 'N'))GOTO 1330
1330	CONTINUE
	IF ((CL .NE. 'Y').OR.(CL .NE. 'N'))GOTO 1340
	GOTO 1300
C
1340	CONTINUE
	J=((POINT-1)/4)+1		!ALARM TABLE LONGWORD
	IF (MOD(POINT,4) .EQ. 0)THEN
		K=24
	ELSE
		K=(MOD(POINT,4)-1)*8	!START OF 8 BIT BLOCK
	END IF
	IF (CL .EQ. 'Y')THEN
		ALARM(J)=JIBSET(ALARM(J),K+3)	!CRITICAL LOW
	ELSE
		ALARM(J)=JIBCLR(ALARM(J),K+3)	!NO CRITICAL LOW
	END IF
C
	IF (CH .EQ. 'Y')THEN
		ALARM(J)=JIBSET(ALARM(J),K+4)	!CRITICAL HIGH
	ELSE
		ALARM(J)=JIBCLR(ALARM(J),K+4)	!NO CRITICAL HIGH
	END IF
	GOTO 35
C
3500	CONTINUE
	WRITE	(2,REC=POINT)PT,ET,SC,RCX,LL,HL,ACPOINT,
	1	INTC,REALC
	WRITE	(3,33,REC=POINT)PN,ED,EU
	IF (LEN .EQ. 0) GOTO 4		!GO HERE FOR NEW POINT
	GOTO 35
C
4000	CONTINUE
	WRITE	(6,4001)
4001	FORMAT	(' .....EXITING ADATABASE PROGRAM...... ')
	CLOSE	(UNIT=2)
	CLOSE	(UNIT=3)
	CALL EXIT
	END
C
	SUBROUTINE CLRSCREEN
C
	CALL 	LIB$ERASE_PAGE(1,1)
	CALL	LIB$SET_CURSOR(1,1)
	RETURN
	END
	
