CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C                                                                   C
C                                                                   C
C                     GAS2X.FOR                                   C
C                                                                   C
C                     RJM 08-OCT-2001                               C
C
C	LINK GAS2X,FLUX_CONTROL/OPT,WESAPI_LIB:WESAPI/OPT
C                                                                   C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	 THIS PROGRAM CONTROLS THE MAIN GAS VALVE 
C       AT THE STEP 2 AGGLOMERATOR 
C
C
	PROGRAM GASCTRL
C
	INTEGER UFO_OPEN
	EXTERNAL UFO_OPEN
	EXTERNAL CLI$M_NOWAIT
C
	INCLUDE '($PRCDEF)'
	INCLUDE '($SSDEF)'
	INCLUDE 'WESAPI:SPD.DCL'
	INCLUDE 'WESAPI:SHC_DEFINES.DCL'
	INCLUDE 'WESAPI:SHC_ERR.DCL'
C
C
	REAL KESPAN/400./,BZSPAN/1000./
C
C
	STRUCTURE	/AM/
	INTEGER*2	ID,AS
	REAL*4		AV
	BYTE		RT,FM,SR,LU
	INTEGER*2	AW,DG
	CHARACTER*8	PN
	INTEGER*2	TB,BB
	END STRUCTURE
C
	RECORD/AM/SYSAOS,AOS(80)   !ANALOG OUTPUT TABLE
C
C
	INTEGER TOTNUM/1800/    !TOTAL NO. OF POINTS IN KE AVG TABLE
C
	REAL 	OBAS(3),RESET(3),GAIN(3),DERIV(3),OUTPUT(3),KEAVG(3),
	1	KOBAS(3),KRESET(3),KGAIN(3),KDERIV(3),
	1	MAXG(3),MAXC(3),MAXKE(3),MINGV(3),KMINUTES(3),KEUP(3),
	1	KETIME(3),PELSTPT(3),PELTEMP(3),PRESET(3),PGAIN(3),
	1	BZOBAS(3),BSET(3)
C
	INTEGER ONGAS(3),DUST(3),ONCOAL(3),KNUM(3),DUSTCOUNT(3),DUSTLIM(3)
C
C
C
	REAL 	KENUMS(3,1800),TEMP_INCREASE(3),TVAL
C
C
	LOGICAL EXIT_HIGH
C
	REAL NBAS
C
C
	REAL ANVALX(1200),AVV,ANVAL(35)
C
C
	INTEGER TIMER(3),SYS$BINTIM,SYS$SCHDWK,
	1	GOOD(69)
C
C
	INTEGER*2 BO,CXOUT(40)
c
C
C
	LOGICAL STAT
C
C
	CHARACTER*6 ALARM /'0 ::02'/
C
	REAL BZTEMP,KEXIT
C
	INTEGER ONCTL(3),KEAN(3),GVAN(3),WGAS(3),BZAN(3),ONGASCX(3),
	1BZSP(3),KESP(3),PELT(3),PSPAN(3)
C
C                        DIGITAL INPUT POINTS
C
	DATA	ONCTL		/51,52,53/,	! on/off HEATUP control
	1	ONGASCX 	/42,43,44/	! on/off gas control
C
C                       
	DATA	KEAN	/2,13,25/, 	! GAS FLOW
	1	BZAN    /1,12,24/,      ! burn zone temp
	1	GVAN	/4,15,27/,   	! gas valve position analog
	1	BZSP	/9,21,33/,
	1	PELT	/6,7,8/,	!pellet bed temperature
	1	PSPAN	/17,18,19/ !not valid
C
C
C		ANALOG OUTPUTS
C                             3  4  5
C
C	MAIN GAS VALVE:      41,28,29
C
C		DIGITAL OUTPUTS
C
C	GAS CONTROL ACKNOWLEDGE DD600007        BOTH LINES & HEATUP
C       SETPOINT SELECT		DD600011	0=KE 1=BZ 	LN 3  
C       SETPOINT SELECT		DD600008	0=KE 1=BZ 	LN 4  
C       SETPOINT SELECT		DD600009	0=KE 1=BZ 	LN 5  
C
C
	REAL	TC 	!SPANS FOR BZ AND KE ANALOGS
C
C
	REAL BZSETPNT,KESETPNT
C
C
	INTEGER BOBZ
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
cccccccccccccccccccccccccccccccccccccccccccccccccccccc
C
C
C
	INTEGER*4	LIB$SYS_TRNLOG
	INTEGER*4	i
	CHARACTER*10 	choice
	INTEGER*4 	status
	CHARACTER*20	highway

	CHARACTER*40    spd_filename
	INTEGER*2	spd_filename_len
	INTEGER*2	spd_fd
	INTEGER*2	access_type
C
	integer		sid
C
C  Case 2 variables
	REAL		get_analog_val
	INTEGER*2	get_analog_stat
C
C
C  Case 3 variables
	INTEGER*4       gp_sid
	BYTE		gp_bitnum 
	INTEGER*2	digital_val
	INTEGER*2	digital_stat
c
c
	BYTE		extended_flag
	BYTE		gp_bit_num
        BYTE		inactive_flag
c
C	CASE 7 VARIABLES
	REAL		put_analog_val
c
C	CASE 8 VARIABLES
	INTEGER*2	put_digital_val
c
c	CASE 45 VARIABLES
	INTEGER*4	point_quality
	INTEGER*4	quality_stat
c
c
	CHARACTER APT*8
	INTEGER SYSID(69)
	integer*2 CXSTS(69)
c
C
C                              

C                                        
C
C
	COMMON /GAS2/ OBAS,RESET,GAIN,DERIV,KEAVG,KOBAS,
	1	KRESET,KGAIN,KDERIV,ONGAS,ONCOAL,DUST,KNUM,
	1	DUSTCOUNT,DUSTLIM,MAXG,MAXC,OUTPUT,MAXKE,MINGV,
	1	KMINUTES,KEUP,KETIME,PELTEMP,PELSTPT,
	1	BZOBAS,PRESET,PGAIN,BSET
C
C
cccccccccccccccccccccccccccccccccccccccccccccccccccccc
C
C
	STAT(m)=bitest(cxsts(m),0)
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C  Use the wesapi highway number to form the name of the wesapi logical that
C  names the point directory file and get the file name from the logical
C
           status = LIB$SYS_TRNLOG('WESAPI_PDIR_0',
	1		spd_filename_len,spd_filename,,,)
C
        IF (status .NE. SS$_NORMAL) THEN
	   PRINT *, '  Logical WESAPI_PDIR not defined'
	   stop 'no point dir'
        ENDIF
C
C
C
C  Put a NULL character (0) at the end of the file name string.  This is
C  necessary because the spd library functions expect string arguments
C  to be NULL terminated strings.
	spd_filename(spd_filename_len+1:) = CHAR(0)

C  Call the spd open file function to get access to the point directory file
        access_type = RUNTIME
        spd_fd = SPD_open_file(%ref(spd_filename), access_type)
        IF (spd_fd .LT. 0) THEN
           PRINT *,'  SPD_open_file() Error : ',spd_fd
           STOP
  	ENDIF
C
C
C
C
C
C	  READ IN ANALOG POINT NOS. FROM GASCTRL.SRC
C
	OPEN (UNIT=50,FILE='USER_D:[RJM]GASCTRL.SRC',STATUS='OLD',
	1	SHARED,READONLY)
C
	JJ=0
	KK=1
C
	DO WHILE (JJ .EQ. 0)
54		READ (50,55,IOSTAT=JJ,err=552) APT
55		FORMAT (A)
		IF (APT(1:1) .LT. '0') GO TO 54
c
c
C  Call the get sid function.  The point name argument must have a NULL (0)
C  at the end.
           status = SPD_get_sid(spd_fd, %ref(apt//char(0)), sid,
	1		gp_sid, gp_bit_num, extended_flag, inactive_flag)
c
	SYSID(KK)=SID
	KK=KK+1
c
	END DO
C
552	CLOSE (50) 	!CLOSE GASCTRL.SRC FILE
c
C  Close the point directory file 
           status = SPD_close_file(spd_fd)
           IF (status .NE. 0) THEN
    	      PRINT *,'  SPD_close_file() Error : ', status
	      STOP
	   ENDIF
c
c
	status = SHC_open_memory()
c	IF (status .NE. SHC_OK) THEN
c	   PRINT *,' SHC open memory failure - error = ',status
c	   STOP
c	ENDIF
c
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C	ALL SIDS' ARE IN SYSID(69)
C
C	SYSID(1-35) CI;  SYSID(36-56) AI;  SYSID(57-60) CO;  SYSID(61-69) AO
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C
C
C	SCHEDULING A 2 SECOND WAKEUP REQUEST
C
C       CONVERT ASCII TIME TO BINARY
C
	STATUS=SYS$BINTIM (ALARM,TIMER)   
C
C	SCHEDULE WAKEUP
C
	STATUS=SYS$SCHDWK (,,TIMER,TIMER)
C
C
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C
C	FILL THE GAS2 COMMON WITH THE DATA IN GAS2.DAT WHEN THE PROGRAM
C	IS RESTARTED ONLY!
C
C
 	OPEN (UNIT=11,FILE='D_I:GAS2.DAT',STATUS='UNKNOWN',
	1	FORM='UNFORMATTED',RECL=200,ACCESS='DIRECT',
	1	RECORDTYPE='FIXED'
	2	,SHARED,USEROPEN=UFO_OPEN)
C
C
	READ (11,REC=1)OBAS,RESET,GAIN,DERIV,KEAVG,KOBAS,
	1	KRESET,KGAIN,KDERIV,ONGAS,ONCOAL,DUST,KNUM,
	1	DUSTCOUNT,DUSTLIM,MAXG,MAXC,OUTPUT,MAXKE,MINGV,
	1	KMINUTES,KEUP,KETIME,PELTEMP,PELSTPT,
	1	BZOBAS,PRESET,PGAIN,BSET
C
	CLOSE (11)
C
C
C
C
C
C
C
C
C
C
C	toggle contact output no. 1 to keep GAS on control
C
C
1	status = SHC_get_digital_val_stat( SYSID(57), gp_sid, gp_bitnum,
	1		digital_val, digital_stat)
C
			IF (DIGITAL_VAL) THEN
				PUT_DIGITAL_VAL=0
			ELSE
				PUT_DIGITAL_VAL=1
			END IF
C
	POINT_QUALITY=0
	STATUS=SHC_PUT_POINT_QUALITY (SYSID(57),POINT_QUALITY)
c
	status=shc_put_digital_val (sysid(57),put_digital_val)
C
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	READ IN THE ANALOG VALUES FROM GASCTRL.SRC EVERY SCAN
C
C
	DO 300 J=1,35
	STATUS=SHC_GET_ANALOG_VAL_STAT (SYSID(J),GET_ANALOG_VAL,
	1	GET_ANALOG_STAT)
C
	GOOD(J)=1
	IF (bitest(get_analog_stat,8)
	1 .or. bitest(get_analog_stat,9) .or. bitest(get_analog_stat,15))
	1	GOOD(J)=0
C
C
	ANVAL(J)=GET_ANALOG_VAL
C
C
300	CONTINUE
C
C
CCCCCCCCCCCCCCC
C
C
C	READ IN CONTACT VALUES
C
	DO 301 J=36,56
C
	gp_sid=0
	gp_bitnum=0  
	status = SHC_get_digital_val_stat( SYSID(J), gp_sid, gp_bitnum,
	1		digital_val, digital_stat)
C
C
	CXSTS(J)=DIGITAL_VAL
C
C
301	CONTINUE
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C                      
C
C
C
C
C
	DO 2000 LINE=1,3	!main loop to do lines 3,4,5
C
	BOBZ=0
C
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C		convert no. of minutes to average GAS FLOW: (kminutes) to
C		no. of points. ((kminutes*60 sec.)/2)  where 2 is the scan
C		rate in seconds.
C
C
	NOP=KMINUTES(LINE)*60/2
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C
C
	IF (STAT(ONCTL(LINE))) GO TO 2000 	!SEE IF HEATUP IS ON
C
C
C
C
C
C  	CHECK ALL ANALOGS
C
	ANOK=0
C
	IF (GOOD(KEAN(LINE))) THEN
C
		KEXIT = ANVAL(KEAN(LINE))
	ELSE
		CALL ALARMS ((KEAN(LINE)),1,LINE)
C
		ANOK=ANOK+1    ! SET IF ANALOG BO
C
	END IF
C
C
	IF (GOOD(BZAN(LINE))) THEN         	! BURN ZONE temp.
C
		BZTEMP = ANVAL(BZAN(LINE))
	ELSE
C
C	 if bztemp is b.o. stick 2000 in it to force it over to dust
		BOBZ=1
CCCCCC		CALL ALARMS ((BZAN(LINE)),1,LINE)
C
CCCCC		ANOK=ANOK+1    ! SET IF ANALOG BO
C
	END IF
C
C
C
	IF (GOOD(GVAN(LINE))) THEN         ! main gas valve position
C
		VALVP= ANVAL(GVAN(LINE))
	ELSE
		CALL ALARMS ((GVAN(LINE)),1,LINE)
C
	END IF
C
C
	IF (GOOD(BZSP(LINE))) THEN         ! BURN ZONE SETPOINT
C
		BZSETPNT= ANVAL(BZSP(LINE))
	ELSE
		CALL ALARMS ((BZSP(LINE)),1,LINE)
C
	END IF
C
C
	IF (GOOD(PELT(LINE))) THEN         ! PELLET BED TEMP.
C
		PELTEMP(LINE)= ANVAL(PELT(LINE))
	ELSE
		CALL ALARMS ((PELT(LINE)),1,LINE)
C
	END IF
C
C
C
		PELSTPT(LINE)= oncoal(line)
C                  
C
C
C	    check if this is first time ON CONTROL.
	IF (STAT(ONGASCX(LINE))) THEN
C
C		   
		IF (.NOT. ONGAS(LINE)) THEN
c		   enter this routine if it's first time on control
c
			ONGAS(LINE)=1
			OBAS(LINE)=VALVP
			OUTPUT(LINE)=VALVP
			DUST(LINE)=0
			KNUM(LINE)=0
			BZOBAS(LINE)=BZSETPNT
			BSET(LINE)=BZSETPNT
			KEAVG(LINE)=0
C
			DO 88 I=1,TOTNUM
88				KENUMS(LINE,I)=0.
		END IF
C
	ELSE
		ONGAS(LINE)=0
		DUST(LINE)=0
C
		BZOBAS(LINE)=BZSETPNT
		BSET(LINE)=BZSETPNT
		KEAVG(LINE)=KEXIT
C
		OUTPUT(LINE)=VALVP
C
C
CCCCCCCCCCCC
C
C	OUTPUT GAS VALVE POSITION TO WESTINGHOUSE
C
C
C
	POINT_QUALITY=0
	STATUS=SHC_PUT_POINT_QUALITY (SYSID(60+line),POINT_QUALITY)
c
	PUT_ANALOG_VALUE=OUTPUT(LINE)
C
	STATUS=SHC_PUT_ANALOG_VAL (SYSID(60+LINE),PUT_ANALOG_VALUE)
C
		GO TO 2000	!DO NEXT LINE
C
	END IF
C
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C	AVERAGE GAS FLOW
C
C
	IF ( .NOT. DUST(LINE)) THEN
C
		IF (KNUM(LINE) .EQ. NOP) GO TO 582
C
		KNUM(LINE)=KNUM(LINE)+1
C
		IF (KNUM(LINE) .LE. 1) THEN
			KEAVG(LINE)=KEXIT
			GO TO 140
		END IF
C
582		KEAVG(LINE)=0.
		L=0
C
		DO 120 I=KNUM(LINE),2,-1
			KENUMS(LINE,I)=KENUMS(LINE,I-1)
			IF (KENUMS(LINE,I) .LE. 0) GO TO 120
				KEAVG(LINE)=KEAVG(LINE)+KENUMS(LINE,I)
			L=L+1
120		CONTINUE
C
		KENUMS(LINE,1)=KEXIT
C
		IF (KENUMS(LINE,1) .LE. 0) GO TO 121
		KEAVG(LINE)=KEAVG(LINE)+KENUMS(LINE,1)
		L=L+1
C
121		IF (L .LE. 0) GO TO 140
C
		KEAVG(LINE)=KEAVG(LINE)/L
C
C
	END IF
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
140	IF ((BZSETPNT-BZTEMP) .GE. DUSTLIM(LINE) .OR. BOBZ .EQ. 1) THEN
C
		IF (.NOT. DUST(LINE)) THEN
			DUSTCOUNT(LINE)=DUSTCOUNT(LINE)+1
			IF (DUSTCOUNT(LINE) .GE. 3) THEN
				DUST(LINE)=1
				KOBAS(LINE)=OUTPUT(LINE)
				IF (KEAVG(LINE) .LE. 0) KEAVG(LINE)=KEXIT
				DO 41 I=1,TOTNUM
41					KENUMS(LINE,I)=0.
			ELSE
				GO TO 2000	!its not dusty yet, but
C						 dont change valve.
			END IF
		END IF
C
	ELSE
C                 no dust!
C
		IF (DUST(LINE)) THEN
		TEMP_INCREASE(LINE)=0
		DUST(LINE)=0
		DUSTCOUNT(LINE)=0
		OBAS(LINE)=OUTPUT(LINE)
		KNUM(LINE)=0
C
		DO 499 JJ=1,TOTNUM
499			KENUMS(LINE,JJ)=KEAVG(LINE)
		END IF
C
C
	END IF
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	CHECK THAT KILN EXIT TEMP IS BELOW MAXIMUM (MAXKE)
C
ccc	IF (KEXIT .GT. MAXKE(LINE)) THEN
C
ccc		EXIT_HIGH=.TRUE.
C
ccc	ELSE
C
		EXIT_HIGH=.FALSE.
C
ccc	END IF
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C
	IF (DUST(LINE)) THEN
C
C
		TEMP_INCREASE(LINE)=TEMP_INCREASE(LINE)+1
		TVAL=KETIME(LINE)*60./2
C
		IF (TVAL .GT. 0) THEN
		IF (TEMP_INCREASE(LINE) .LT. TVAL)
	1 	 KEAVG(LINE)=KEAVG(LINE)+(KEUP(LINE)/(KETIME(LINE)*60./2))
		END IF
C
C
		IF (KEAVG(LINE) .GT. MAXKE(LINE)) KEAVG(LINE)=MAXKE(LINE)
C
C
		ERROR= ((KEAVG(LINE)-KEXIT)*100)/KESPAN
C
C		  drop valve if exit temp is above maximum
ccccc		IF (EXIT_HIGH) THEN
ccccc			ERROR=-2.00
ccccc		END IF
C
C
		NBAS= ERROR*KRESET(LINE)+KOBAS(LINE)
C
		KOBAS(LINE)=NBAS
		IF (KOBAS(LINE) .LT. MINGV(LINE)) KOBAS(LINE)=MINGV(LINE)
		IF (KOBAS(LINE) .GT. MAXG(LINE)) KOBAS(LINE)=MAXG(LINE)
C
C
		OUTPUT(LINE)= ERROR*KGAIN(LINE)+NBAS
C
C		
C
		IF (OUTPUT(LINE) .GT. MAXG(LINE)) OUTPUT(LINE)=MAXG(LINE)
		IF (OUTPUT(LINE) .LT. MINGV(LINE)) OUTPUT(LINE)=MINGV(LINE)
C
C
	POINT_QUALITY=0
	STATUS=SHC_PUT_POINT_QUALITY (SYSID(60+line),POINT_QUALITY)
c
	PUT_ANALOG_VALUE=OUTPUT(LINE)
C
	STATUS=SHC_PUT_ANALOG_VAL (SYSID(60+LINE),PUT_ANALOG_VALUE)
C
C
	ELSE
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C               adjust the BURN ZONE SETPOINT based on the diff. between
C               the pellet temp and pellet setpoint.
C
                ERROR=(PELSTPT(LINE)-PELTEMP(LINE))*100/2500
                NBAS=ERROR*PRESET(LINE)+BZOBAS(LINE)
                BZOBAS(LINE)=NBAS
                BSET(LINE)=ERROR*PGAIN(LINE)+NBAS
c
c
c
C                 keep the calculated bz setpoint + or - 25 degrees of
c                 the dialed in westinghouse bz setpoint
c
                IF (BSET(LINE) .LT. (BZSETPNT-25.)) THEN
                        BSET(LINE)=BZSETPNT-25.
                        BZOBAS(LINE)=BZSETPNT-25.
                ELSE IF (BSET(LINE) .GT. (BZSETPNT+25.)) THEN
                        BSET(LINE)=BZSETPNT+25.
                        BZOBAS(LINE)=BZSETPNT+25.
                END IF
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
		ERROR= ((BSET(LINE)-BZTEMP)*100)/BZSPAN
C
C
C		  drop valve if exit temp is above maximum
ccccc		IF (EXIT_HIGH) THEN
ccccc			ERROR=-2.00
ccccc		END IF
C
		NBAS= ERROR*RESET(LINE)+OBAS(LINE)
C
		OBAS(LINE)=NBAS
		IF (OBAS(LINE) .LT. MINGV(LINE)) OBAS(LINE)=MINGV(LINE)
		IF (OBAS(LINE) .GT. MAXG(LINE)) OBAS(LINE)=MAXG(LINE)
C
C
		OUTPUT(LINE)= ERROR*GAIN(LINE)+NBAS
C
C		
C
C
		IF (OUTPUT(LINE) .GT. MAXG(LINE)) OUTPUT(LINE)=MAXG(LINE)
		IF (OUTPUT(LINE) .LT. MINGV(LINE)) OUTPUT(LINE)=MINGV(LINE)
C
C
C
	POINT_QUALITY=0
	STATUS=SHC_PUT_POINT_QUALITY (SYSID(60+line),POINT_QUALITY)
c
	PUT_ANALOG_VALUE=OUTPUT(LINE)
	STATUS=SHC_PUT_ANALOG_VAL (SYSID(60+LINE),PUT_ANALOG_VALUE)
C
	END IF
C
C
C
C
C
C
2000	CONTINUE
C
C
C
C
C
C
	CALL SYS$HIBER ()
C
 	GO TO 1
C
C                                                      
	END
C
C
C
C
C
	SUBROUTINE ALARMS(JPTNUM,MSGNO,LINE)
C
C
C
C
	INTEGER PUSHTIM(2),ENDTIM(2),ONHEAT,
	1	KLCX(3),KLEMCX(3),F3CX(3),KLUBCX(3),
	2	STAKCX(3),ONCTL(3)/1267,1608,1609/,
	1	KEAN(5),GVAN(3),ON2,CAP
C
	LOGICAL GRATE,KILN
	INTEGER TIMER(2),STATUS,SYS$BINTIM,SYS$SCHDWK,SYS$HIBER,
	1	LIB$SPAWN,GOODPT(50),CXSTS(100),PRINT
C
C
	INTEGER*2 BO,CXOUT(40),GOOD,STAT
C
C 
C
C
	CHARACTER MSG(3)*40,PT*4,FMSG*40
C
C
C
	DATA 	MSG(1)/'SIGNAL BO'/,
	1    	MSG(2)/'HEATUP IS OVER'/	
	1	MSG(3)/'3A FAN STOPPED'/
C
	REAL 	OBAS(3),RESET(3),GAIN(3),DERIV(3),OUTPUT(3),KEAVG(3),
	1	KOBAS(3),KRESET(3),KGAIN(3),KDERIV(3),
	1	MAXG(3),MAXC(3),MAXKE(3),MINGV(3),KMINUTES(3),KEUP(3),
	1	KETIME(3),PELSTPT(3),PELTEMP(3),PRESET(3),PGAIN(3)
C
	INTEGER ONGAS(3),DUST(3),ONCOAL(3),KNUM(3),DUSTCOUNT(3),DUSTLIM(3)
C
C
C
	COMMON /GAS2/ OBAS,RESET,GAIN,DERIV,KEAVG,KOBAS,
	1	KRESET,KGAIN,KDERIV,ONGAS,ONCOAL,DUST,KNUM,
	1	DUSTCOUNT,DUSTLIM,MAXG,MAXC,OUTPUT,MAXKE,MINGV,
	1	KMINUTES,KEUP,KETIME,PELSTPT,PELTEMP,PRESET,PGAIN
C
C                  
C
	IF (ONGAS(LINE) .NE. 0) THEN
C
C		UNIT 1 IS THE OUTPUT PRINTER FOR THE CX AND ANALOG
C                                                    ALARM MESSAGES
C
ccccc		OPEN (UNIT=1,FILE='LTA015:',STATUS='UNKNOWN',CARRIAGE
ccccc	1	CONTROL='LIST',ERR=1234)
C
	IF ((JPTNUM .LE. 0) .OR. (JPTNUM .GT. 2000)) THEN
		PT='    '     
	ELSE
C
	WRITE (PT,'(I4)')JPTNUM
	END IF
C
C patch
cccccc	WRITE (1,234,err=1234) LINE+2,PT
C
c234	FORMAT (' ','LINE ',I1,2X,
c	1	'gas CONTROL ERROR MESSAGE'/' ','POINT NO. ',A4,/
c	1	' ',' TAKE GAS CONTROL OFF COMPUTER !!')
C
C
cccccc	IF (MSGNO .GE. 1) THEN
C
cccccc		WRITE (1,604,err=1234) MSG(MSGNO)
C       
cccccc	END IF
C
C
1234	CLOSE (1)
C
C
	END IF
C
C
	RETURN
C
C
604	FORMAT (' ',A40)
C
	END
