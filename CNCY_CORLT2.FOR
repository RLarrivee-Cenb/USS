	PROGRAM CNCY_CORLT2 
C
C	THIS PROGRAM COLLECTS THE DATA SPECIFIED BY THE 
C	CNCY_CORLTX PROGRAM AND PUTS THE DATA IN THE CNCY_CORLT2.DAT FILE
C	IT WAS BUILT SPECIFICALLY FOR DOUG JOHNSON
C
	IMPLICIT NONE
C
	REAL*4		ANVAL(1900),
	1		VALUES(12),
	1		ACCUMS(12),
	1		OBS(12)
C
	INTEGER*4	POINT(12),
	1		INTVL,
	1		INTVLC,
	1		SCANC,
	1		RUNFLG,
	1		STRSTP
C
	INTEGER*4	I,J,K,M,ADDRESS(2),BIT
	INTEGER*4	UFO_OPEN
C
	CHARACTER*18	FILE/'GP:CNCY_CORLT2.DAT'/
	CHARACTER*18	FILEX/'GP:CNCY_CORLAT.DAT'/
	CHARACTER*23	STRTIME,STPTIME
	CHARACTER*8	TIME/'0 0:0:10'/
	CHARACTER*1	TYPE(12),AVG
	INTEGER*4	CXSTS(100)
C
	EXTERNAL	UFO_OPEN
C
	COMMON/CNC_ANVALTBL/ANVAL
	COMMON/CONTACTSCNC/CXSTS
	COMMON/CNCY_CORLTXTBL/TYPE,POINT,INTVL,INTVLC,AVG,
	1		SCANC,RUNFLG,STRSTP,ACCUMS,OBS,
	1		STRTIME,STPTIME
C
		OPEN (UNIT=2,FILE=FILEX,USEROPEN=UFO_OPEN,
	1		ACCESS='DIRECT',SHARED,RECL=66,
	1		STATUS='OLD',
	1		FORM='UNFORMATTED',RECORDTYPE='FIXED')
C
	READ	(2,REC=1)TYPE,POINT,INTVL,INTVLC,AVG,
	1		SCANC,RUNFLG,STRSTP,ACCUMS,OBS,
	1		STRTIME,STPTIME
C
	CLOSE	(UNIT=2)
C
	IF (RUNFLG .EQ. 0)GOTO 9999	!NO WORK ... SHUT OFF
C
	CALL	SYS$BINTIM(TIME,ADDRESS)
	CALL	SYS$SCHDWK(,,ADDRESS,ADDRESS)
C
250	CONTINUE
C
	IF(SCANC .EQ. 1500)THEN	!HAVE WE FILLED UP FILE
		RUNFLG=0
		CALL	LIB$DATE_TIME(STPTIME)
		GOTO 9999
	END IF
C
	IF (STRSTP .EQ. 1)THEN	!HAVE WE BEEN STOPPED
		RUNFLG=0	!CLEAR RUN FLAG
		STRSTP=0	!CLEAR STOP FLAG
		CALL	LIB$DATE_TIME(STPTIME)
		GOTO 9999	!GO SHUT OFF
	END IF
C
	IF (INTVLC .EQ. 0)THEN
		DO 300 I=1,12
			ACCUMS(I)=0	!SET UP FOR AVERAGING
			OBS(I)=0	!NEW TIME INTERVAL
300		CONTINUE
	END IF
C
	IF (AVG .EQ. 'Y')THEN
		DO 400 I=1,12
			IF (POINT(I) .EQ. 0)GOTO 400
C
		IF ((POINT(I) .EQ. 1204).AND.(TYPE(I) .EQ. 'A'))THEN
				ACCUMS(I)=ANVAL(POINT(I))
				OBS(I)=1
				GOTO 400
			END IF
C
			IF (TYPE(I) .EQ. 'A')THEN
				ACCUMS(I)=ACCUMS(I)+ANVAL(POINT(I))
				OBS(I)=OBS(I)+1
			ELSE
				J=(POINT(I)/32)+1
				K=MOD(POINT(I),32)
				BIT=JIBITS(CXSTS(J),K,1)	
				ACCUMS(I)=BIT
				OBS(I)=1
			END IF
400		CONTINUE
	END IF
C
	IF (AVG .EQ. 'N')THEN
		DO 500	I=1,12
			IF (POINT(I) .EQ. 0)GOTO 500
			IF (TYPE(I) .EQ. 'A')THEN
				ACCUMS(I)=ANVAL(POINT(I))
				OBS(I)=1
			ELSE
				J=(POINT(I)/32)+1
				K=MOD(POINT(I),32)
				BIT=JIBITS(CXSTS(J),K,1)
				ACCUMS(I)=BIT
				OBS(I)=1
			END IF
C
500		CONTINUE
	END IF
C
	INTVLC=INTVLC+1
	IF (INTVLC .EQ. INTVL)THEN
		DO 600	I=1,12
			IF (POINT(I) .EQ. 0)GOTO 600
			ACCUMS(I)=ACCUMS(I)/OBS(I)
600		CONTINUE
		SCANC=SCANC+1	!BUMP POINTS COLLECTED COUNTER
		INTVLC=0	!RESET AVG INTERVAL COUNTER
C
		OPEN (UNIT=2,FILE=FILE,USEROPEN=UFO_OPEN,
	1		ACCESS='DIRECT',SHARED,RECL=12,
	1		STATUS='OLD',
	1		FORM='UNFORMATTED',RECORDTYPE='FIXED')
C
		WRITE	(2,REC=SCANC)ACCUMS	!WRITE TO FILE
C
		CLOSE	(UNIT=2)
C
	END IF
C
		OPEN (UNIT=2,FILE=FILEX,USEROPEN=UFO_OPEN,
	1		ACCESS='DIRECT',SHARED,RECL=66,
	1		STATUS='OLD',
	1		FORM='UNFORMATTED',RECORDTYPE='FIXED')
C
	WRITE	(2,REC=1)TYPE,POINT,INTVL,INTVLC,AVG,
	1		SCANC,RUNFLG,STRSTP,ACCUMS,OBS,
	1		STRTIME,STPTIME
C
	CLOSE	(UNIT=2)
C
	CALL	SYS$HIBER()	!DELAY TILL NEXT RUN
	GOTO 	250
C
9999	CALL	EXIT
C
	END
